## 一、技术背景

公司的各项技术与产品依托于车路协同系统。车路协同系统（cooperative vehicle-infrastructure system, CVIS）是基于无线通信、传感探测等技术，全方位实施车车、车路动态实时信息交互, 实现车辆和基础设施之间智能协同与配合, 进而优化利用系统资源、提高道路交通安全、缓解交通拥堵的道路交通系统。其具体包括了智能网联汽车、V2X通信系统以及智能网联道路系统三大部分。

## 二、产品介绍

成套关键产品可支持100+应用场景，应用场景包括广播类，雷视融合类、端控类（包括辅助单车智能应用类、路基管控类、路基自动驾驶类、车基管控类，应急救援类），中心类，共分为22个模块。

### 2.1 路侧单元

### 2.2 车载单元

### 2.3 边缘计算单元

### 2.4 云平台

## 三、解决方案

### 3.1 高速公路智慧升级解决方案

高速公路的解决方案涉及路侧感知设备、路侧管控设备、边缘计算设备、车载单元、路侧通信单元以及云平台。

边缘计算设备融合路侧感知设备、通信单元信息，综合考虑车辆需求，与云端结合，  通过可变信息板、V2X通信等手段进行信息的下发，缓解目前高速公路存在的超视距、恶劣天气、专用道空置等痛点问题，提出桥梁、隧道事故、二次事故防护及快速有序疏散解决方案，能够有效保障安全，提升交通效率。

![image-20211119091401704](https://gitee.com/er-huomeng/l-img/raw/master/image-20211119091401704.png)

![image-20211119091452166](https://gitee.com/er-huomeng/l-img/raw/master/image-20211119091452166.png)

### 3.2 城市道路智慧升级解决方案

城市道路的解决方案涉及边缘计算单元、交通信号灯、路侧感知设备、通信设备以及云平台等。路侧感知设备是整个系统的眼睛，它主要由高清摄像头、激光雷达、毫米波雷达等组成，边缘计算产品负责辅助计算、数据采集融合、评价、决策和管控方案的下发。

解决方案可以在利用存量设备的前提下进行智慧升级，且边缘计算设备支持自组网协同，有效降低区域协同优化成本。此外，产品还可以接收到附近其它车路协同设备的数据，也可以从云端获取数据，实现“人-车-路-云”协同工作。城市的交通通行效率、交通安全和出行服务质量将得到有效提高。

![image-20211119091318798](https://gitee.com/er-huomeng/l-img/raw/master/image-20211119091318798.png)

![image-20211119091340193](https://gitee.com/er-huomeng/l-img/raw/master/image-20211119091340193.png)

### 3.3 智慧公交解决方案

城市智慧公交可以实现公交专用道动态管控、公交信号优化、公交驻站与信号协同优化等功能。且公交信号优化采用“双准则”优先，在保障公交优先通行的同时保障社会车辆的利益。边缘计算设备融合路侧感知设备、通信单元数据以及云平台信息，进行综合考虑和建模分析，通过V2I通信、V2X通信、可变信息板等手段下发信号优先、驻站辅助、驾驶辅助信息，有效提高公交和社会车辆的协同运行效率。

![image-20211119091531959](https://gitee.com/er-huomeng/l-img/raw/master/image-20211119091531959.png)

### 3.4 城市智慧管控解决方案

城市智慧管控解决方案，主要包括多源数据驱动下交叉口信号控制水平的“评估-诊断-优化”，以及行人过街、可变车道等交通管理手段的智能化提升。

面向传统的数据环境、全息感知环境以及车路联网环境，优化交通设计与控制方案，实现个体适应最佳、配时参数最优、相位设计合理、网络主动预防、以及设施利用最佳等目标交通设计、组织、管理和控制全链条。

![image-20211119091622209](https://gitee.com/er-huomeng/l-img/raw/master/image-20211119091622209.png)

### 3.5 智慧货运解决方案

智慧货运编队可以节省油耗近30%，智慧货运解决方案包括货运编队规划、货运编队管理以及货运编队保护。其中货运编队规划功能位于云平台，接入各货运企业信息，进行编队规划设计，为各货运车辆给出计划路径和编队节点；货运编队管理则在分合流区进行编队的合并以及拆分，进行编队服务的同时保障社会车辆的正常通行；货运编队保护则通过道钉、可变信息板、匝道信号灯等方式实现相应路段货运、常规交通的隔离以及调整，保护货运编队和社会车辆运行安全。

![image-20211119091640806](https://gitee.com/er-huomeng/l-img/raw/master/image-20211119091640806.png)

## 四、云平台数据结构

### 4.1 数据输入

云平台输入MEC的数据结构

### 4.2 数据输出

MEC上传到云平台的数据结构

### 4.3 云平台数据库

#### 4.3.1 地图数据

表名：Map

| 属性名    | 类型   | 长度 | 小数点 | **必须（-1非必须）** | 字段注释 |
| :-------- | :----- | ---- | ------ | :------------------- | :------- |
| id        | bigint | 0    | 0      | 0                    | 地图编号 |
| timestamp | int    | 0    | 0      | -1                   | 时间戳   |
| region    | bigint | 0    | 0      | 0                    | 区域编号 |

表名：Node

说明：节点。道路线形发生变化处定义为节点，如匝道/车道减少等情况。

| 属性名 | 类型    | 长度 | 小数点 | **必须（-1非必须）** | 字段注释                              |
| :----- | :------ | ---- | ------ | :------------------- | :------------------------------------ |
| id     | bigint  | 0    | 0      | 0                    | 节点编号                              |
| region | bigint  | 0    | 0      | 0                    | 区域编号                              |
| name   | varchar | 50   | 0      | -1                   | 节点名称                              |
| lon    | double  | 0    | 7      | 0                    | 经度，精确到微度，范围（-180°~+180°） |
| lat    | double  | 0    | 7      | 0                    | 纬度，精确到微度，范围（-90°~+90°）   |
| ele    | double  | 0    | 1      | 0                    | 海拔高度，范围（-409.5m~+6143.9m）    |

表名：Link

说明：路段。两个节点之间定义为一个路段。

| 属性名           | 类型    | 长度 | 小数点 | **必须（-1非必须）** | 字段注释laneId |
| :--------------- | :------ | ---- | ------ | :------------------- | :------------- |
| id               | bigint  | 0    | 0      | 0                    | 路段编号       |
| name             | varchar | 50   | 0      | -1                   | 路段名称       |
| upstreamNodeId   | bignit  | 0    | 0      | 0                    | 上游交叉口编号 |
| downstreamNodeId | bignit  | 0    | 0      | 0                    | 下游交叉口编号 |
| linkWidth        | double  | 0    | 2      | -1                   | 路段宽带       |

表名：Lane

说明：车道。

| 属性名         | 类型    | 长度 | 小数点 | **必须（-1非必须）** | 字段注释laneId                                               |
| :------------- | :------ | ---- | ------ | :------------------- | :----------------------------------------------------------- |
| id             | bigint  | 0    | 0      | 0                    | 车道编号                                                     |
| linkId         | biging  | 0    | 0      | -1                   | 所处路段编号                                                 |
| laneWidth      | double  | 0    | 2      | -1                   | 车道宽度                                                     |
| laneType       | tinyint | 0    | 0      | 0                    | 车道类型（0为机动车道，1为人行横道，2为非机动车道，3为人行道，4为分隔带，5为路标，6为列车道 ，7为停车道） |
| laneAttribute  | tinyint | 0    | 0      | 0                    | 车道属性，多选类型（二进制情况下用01去代表是否选择该位的属性）（1为客车，2为货车，3为公交车，4为出租车，5为大型车，6为中型车，7为小型车，8为其他机动车，9为非机动车，10为行人） |
| maneuver       | tinyint | 0    | 0      | -1                   | 允许的车道功能，多选类型（二进制情况下用01去代表是否选择该位的属性）（1为直行，2为左转，3为右转，4为掉头，5为换道，6为禁停，7为慎行） |
| speedLimitType | array   | 0    | 0      | -1                   | 限速类型列表（0为未知，1为学校区域最大速度，2为有儿童在场时的学校区域最大速度，3为施工区最大速度，4为车辆最小速度，5为车辆最大速度，6为车辆夜间最大速度，7为货车最小速度，8为货车最大速度，9为货车夜间最大速度，10为有拖车时最小速度，11为有拖车时最大速度，12为有拖车时夜间最大速度） |
| speed          | array   | 0    | 2      | -1                   | 限速列表（m/s）                                              |

表名：RoadPoint

说明：路段点。

| 属性名    | 类型   | 长度 | 小数点 | **必须（-1非必须）** | 字段注释                              |
| :-------- | :----- | ---- | ------ | :------------------- | :------------------------------------ |
| id        | bigint | 0    | 0      | 0                    | 路段点编号                            |
| lon       | double | 0    | 7      | 0                    | 经度，精确到微度，范围（-180°~+180°） |
| lat       | double | 0    | 7      | 0                    | 纬度，精确到微度，范围（-90°~+90°）   |
| ele       | double | 0    | 1      | 0                    | 海拔高度，范围（-409.5m~+6143.9m）    |
| linkId    | biging | 0    | 0      | -1                   | 所处路段编号                          |
| sectionId | biging | 0    | 0      | -1                   | 所处子路段编号                        |
| laneId    | biging | 0    | 0      | -1                   | 所处车道编号                          |

表名：Connection

说明：连接情况。代表车道之间的物理连接关系。

| 属性名     | 类型   | 长度 | 小数点 | **必须（-1非必须）** | 字段注释     |
| :--------- | :----- | ---- | ------ | :------------------- | :----------- |
| id         | bigint | 0    | 0      | 0                    | 连接编号     |
| fromLaneId | int    | 0    | 0      | 0                    | 上游车道编号 |
| toLaneId   | int    | 0    | 0      | 0                    | 下游车道编号 |

表名：Section

说明：子路段。根据雷视检测区域划分路段。

| 属性名    | 类型   | 长度 | 小数点 | **必须（-1非必须）** | 字段注释       |
| :-------- | :----- | ---- | ------ | :------------------- | :------------- |
| id        | bigint | 0    | 0      | 0                    | 子路段编号     |
| linkId    | bigint | 0    | 0      | 0                    | 所处路段编号   |
| pileStart | bigint | 0    | 0      | 0                    | 子路段起始桩号 |
| pileEnd   | bigint | 0    | 0      | 0                    | 子路段结束桩号 |

表名：TollStation

说明：收费站。

| 属性名        | 类型    | 长度 | 小数点 | **必须（-1非必须）** | 字段注释                                                     |
| :------------ | :------ | ---- | ------ | :------------------- | :----------------------------------------------------------- |
| id            | bigint  | 0    | 0      | 0                    | 编号                                                         |
| name          | varchar | 50   | 0      | 0                    | 收费站名称                                                   |
| type          | int     | 0    | 0      | -1                   | 收费站类型                                                   |
| fromSectionId | biging  | 0    | 0      | -1                   | 上游子路段编号                                               |
| toSectionId   | bigint  | 0    | 0      | -1                   | 下游子路段编号                                               |
| vehicleType   | tinyint | 0    | 0      | -1                   | 收费车辆类型，多选类型（二进制情况下用01去代表是否选择该位的属性）（1为客车，2为货车，3为公交车，4为出租车，5为大型车，6为中型车，7为小型车） |

表名：ServiceArea

说明：服务区。

| 属性名        | 类型    | 长度 | 小数点 | **必须（-1非必须）** | 字段注释       |
| :------------ | :------ | ---- | ------ | :------------------- | :------------- |
| id            | bigint  | 0    | 0      | 0                    | 编号           |
| name          | varchar | 50   | 0      | 0                    | 服务区名称     |
| type          | int     | 0    | 0      | -1                   | 服务区类型     |
| fromSectionId | bigint  | 0    | 0      | -1                   | 上游子路段编号 |
| toSectionId   | bigint  | 0    | 0      | -1                   | 下游子路段编号 |

表名：Ramp

说明：匝道。

| 属性名        | 类型    | 长度 | 小数点 | **必须（-1非必须）** | 字段注释       |
| :------------ | :------ | ---- | ------ | :------------------- | :------------- |
| id            | bigint  | 0    | 0      | 0                    | 编号           |
| name          | varchar | 50   | 0      | 0                    | 匝道名称       |
| type          | int     | 0    | 0      | -1                   | 匝道类型       |
| fromSectionId | bigint  | 0    | 0      | -1                   | 上游子路段编号 |
| toSectionId   | bigint  | 0    | 0      | -1                   | 下游子路段编号 |

#### 4.3.2 设备数据

表名：DeviceInfo

说明：设备基本信息。

| 属性名     | 类型    | 长度 | 小数点 | 必须（-1非必须） | 字段注释                              |
| :--------- | :------ | ---- | ------ | :--------------- | :------------------------------------ |
| id         | bigint  | 0    | 0      | 0                | 编号                                  |
| deviceId   | bigint  | 0    | 0      | 0                | 设备id                                |
| deviceType | varchar | 10   | 0      | -1               | 设备类型                              |
| lon        | double  | 0    | 7      | -1               | 经度，精确到微度，范围（-180°~+180°） |
| lat        | double  | 0    | 7      | -1               | 纬度，精确到微度，范围（-90°~+90°）   |
| ele        | double  | 0    | 1      | -1               | 海拔高度，范围（-409.5m~+6143.9m）    |

表名：DeviceManage

设备：设备管理。表示设备的检测范围。

| 属性名        | 类型    | 长度 | 小数点 | 必须（-1非必须） | 字段注释                              |
| :------------ | :------ | ---- | ------ | :--------------- | :------------------------------------ |
| id            | bigint  | 0    | 0      | 0                | 编号                                  |
| timestamp     | int     | 0    | 0      | -1               | 时间戳（min），范围（0min~527040min） |
| sectionIdList | varchar | 50   | 0      | 0                | 检测子路段编号列表                    |
| deviceId      | bigint  | 0    | 0      | 0                | 设备编号                              |
| beginPointId  | bigint  | 0    | 0      | 0                | 检测范围起点编号                      |
| endPointId    | bigint  | 0    | 0      | 0                | 检测范围终点编号                      |
| direction     | int     | 0    | 0      | 0                | 检测方向                              |

表名：MECManage

说明：MEC管理。MEC所管理设备。

| 属性名       | 类型    | 长度 | 小数点 | 必须（-1非必须） | 字段注释                              |
| :----------- | :------ | ---- | ------ | :--------------- | :------------------------------------ |
| id           | bigint  | 0    | 0      | 0                | 编号                                  |
| timestamp    | int     | 0    | 0      | 0                | 时间戳（min），范围（0min~527040min） |
| MECId        | bigint  | 0    | 0      | 0                | MEC设备id                             |
| deviceIdList | varchar | 50   | 0      | 0                | 管理设备编号列表                      |

表名：DeviceAbnormal

说明：设备异常状态。

| 属性名         | 类型    | 长度 | 小数点 | 必须（-1非必须） | 字段注释                                  |
| :------------- | :------ | ---- | ------ | :--------------- | :---------------------------------------- |
| id             | bigint  | 0    | 0      | 0                | 编号                                      |
| timestampStart | int     | 0    | 0      | 0                | 开始时间戳（min），范围（0min~527040min） |
| timestampEnd   | int     | 0    | 0      | 0                | 结束时间戳（min），范围（0min~527040min） |
| deviceId       | bigint  | 0    | 0      | 0                | 设备id                                    |
| abnormalType   | varchar | 50   | 0      | -1               | 异常类型                                  |
| description    | varchar | 100  | 0      | -1               | 问题描述                                  |
| state          | tinyint | 0    | 0      | -1               | 处理状态                                  |

#### 4.3.3 事件数据

表名：RoadsideEvent

说明：路侧事件。

| 属性名         | 类型    | 长度 | 小数点 | 必须（-1非必须） | 字段注释                                                     |
| :------------- | :------ | ---- | ------ | :--------------- | :----------------------------------------------------------- |
| id             | bigint  | 0    | 0      | 0                | 编号                                                         |
| timestampStart | int     | 0    | 0      | 0                | 开始时间戳（min），范围（0min~527040min）                    |
| timestampEnd   | int     | 0    | 0      | 0                | 结束时间戳（min），范围（0min~527040min）                    |
| deviceId       | varchar | 50   | 0      | 0                | 检测器编号                                                   |
| direction      | int     | 0    | 0      | -1               | 方向（针对同一个设备监测双向的情况）                         |
| laneNo         | int     | 0    | 0      | -1               | 车道编号                                                     |
| lon            | double  | 0    | 7      | -1               | 经度，精确到微度，范围（-180°~+180°）                        |
| lat            | double  | 0    | 7      | -1               | 纬度，精确到微度，范围（-90°~+90°）                          |
| ele            | double  | 0    | 1      | -1               | 海拔高度，范围（-409.5m~+6143.9m）                           |
| type           | tinyint | 0    | 0      | -1               | 描述信息警告或交通标志类型，参考国标GB 5768.2和GBT 29100-2012 |
| describe       | varchar | 100  | 0      | -1               | 事件描述                                                     |
| riskLevel      | tinyint | 0    | 0      | -1               | 风险等级                                                     |
| picture        | BLOB    | 0    | 0      | -1               | 事件图片                                                     |
| alertPath      | varchar | 50   | 0      | -1               | 预警路径，轨迹点列表                                         |
| alertRadius    | tinyint | 50   | 0      | -1               | 影响范围                                                     |
| state          | tinyint | 0    | 0      | -1               | 处理状态                                                     |

表名：CenterEvent

说明：中心事件。

| 属性名         | 类型    | 长度 | 小数点 | 必须（-1非必须） | 字段注释                                                     |
| :------------- | :------ | ---- | ------ | :--------------- | :----------------------------------------------------------- |
| id             | bigint  | 0    | 0      | 0                | 编号                                                         |
| timestampStart | int     | 0    | 0      | 0                | 开始时间戳（min），范围（0min~527040min）                    |
| timestampEnd   | int     | 0    | 0      | 0                | 结束时间戳（min），范围（0min~527040min）                    |
| deviceIdList   | varchar | 50   | 0      | 0                | 发布设备编号列表                                             |
| type           | tinyint | 0    | 0      | -1               | 描述信息警告或交通标志类型，参考国标GB 5768.2和GBT 29100-2012 |
| description    | varchar | 100  | 0      | -1               | 事件描述                                                     |
| riskLevel      | tinyint | 0    | 0      | -1               | 风险等级                                                     |
| alertRadius    | tinyint | 50   | 0      | -1               | 影响范围                                                     |

#### 4.3.4 交通数据

表名：TrafficFlow

| 属性名         | 类型    | 长度 | 小数点 | 必须（-1非必须） | 字段注释                                                     |
| :------------- | :------ | ---- | ------ | :--------------- | :----------------------------------------------------------- |
| id             | bigint  | 0    | 0      | 0                | 编号                                                         |
| timestampStart | int     | 0    | 0      | 0                | 开始时间戳（min），范围（0min~527040min）                    |
| timestampEnd   | int     | 0    | 0      | 0                | 结束时间戳（min），范围（0min~527040min）                    |
| deviceId       | varchar | 50   | 0      | 0                | 检测器编号                                                   |
| direction      | int     | 0    | 0      | -1               | 方向（针对同一个设备监测双向的情况）                         |
| laneNo         | int     | 0    | 0      | -1               | 车道编号                                                     |
| density        | double  | 0    | 2      | -1               | 密度（veh/km）                                               |
| speed          | double  | 0    | 2      | -1               | 速度（m/s）                                                  |
| volume         | double  | 0    | 2      | -1               | 流量（veh/h）                                                |
| congestion     | tinyint | 0    | 0      | -1               | 拥堵程度，分为5级，0为畅通，1为较畅通，2为缓慢，3为较拥堵，4为堵塞） |

表名：Vehicle

| 属性名    | 类型    | 长度 | 小数点 | 必须（-1非必须） | 字段注释                                                     |
| :-------- | :------ | ---- | ------ | :--------------- | :----------------------------------------------------------- |
| id        | bigint  | 0    | 0      | 0                | 编号                                                         |
| vehId     | bigint  | 0    | 0      | 0                | 雷视设备中唯一id                                             |
| license   | varchar | 20   | 0      | -1               | 车牌号                                                       |
| vehType   | varchar | 10   | 0      | -1               | 车辆类型，多选类型（二进制情况下用01去代表是否选择该位的属性）（1为客车，2为货车，3为公交车，4为出租车，5为大型车，6为中型车，7为小型车） |
| connected | tinyint | 0    | 0      | -1               | 是否为网联车，0为非网联车，1为网联车                         |

表名：Trajectory

| 属性名    | 类型   | 长度 | 小数点 | 必须（-1非必须） | 字段注释                              |
| :-------- | :----- | ---- | ------ | :--------------- | :------------------------------------ |
| id        | bigint | 0    | 0      | 0                | 编号                                  |
| vehId     | bigint | 0    | 0      | 0                | 车辆id                                |
| timestamp | int    | 0    | 0      | 0                | 时间戳（min），范围（0min~527040min） |
| lon       | double | 0    | 7      | -1               | 经度，精确到微度，范围（-180°~+180°） |
| lat       | double | 0    | 7      | -1               | 纬度，精确到微度，范围（-90°~+90°）   |
| ele       | double | 0    | 1      | -1               | 海拔高度，范围（-409.5m~+6143.9m）    |
| speed     | double | 0    | 2      | -1               | 速度（m/s）                           |
| direction | int    | 0    | 0      | -1               | 方向                                  |
| deviceId  | bigint | 0    | 0      | -1               | 所属雷视编号                          |
| postionX  | double | 0    | 2      | -1               | 雷视坐标系X轴位置                     |
| positionY | double | 0    | 2      | -1               | 雷视坐标系Y轴位置                     |

#### 4.3.5 车路协同服务

表名：IVICSService

说明：车路协同服务。

| 属性名          | 类型    | 长度 | 小数点 | 必须（-1非必须） | 字段注释                                                     |
| :-------------- | :------ | ---- | ------ | :--------------- | :----------------------------------------------------------- |
| id              | bigint  | 0    | 0      | 0                | 编号                                                         |
| name            | varchar | 20   | 0      | 0                | 服务名称                                                     |
| serviceType     | tinyint | 0    | 0      | 0                | 服务类型，0为网联车专有服务，1为网联车普通服务，2为社会车辆服务 |
| timestamp       | int     | 0    | 0      | 0                | 触发时间戳                                                   |
| vehicleServiced | int     | 0    | 0      | 0                | 服务车辆数                                                   |

#### 4.3.6 视频数据

## 五、MEC数据结构

### 5.1 TrafficEvent

类型名：TrafficEvent

| 属性名      | 类型         | 属性         | 备注       |
| :---------- | :----------- | :----------- | :--------- |
| eventId     | string       | 事件ID       | -          |
| eventType   | int          | 事件类型     | -          |
| source      | string       | 来源         | -          |
| eventPos    | Position3D   | 事件位置     | -          |
| eventRadius | int          | 事件范围     | 单位：0.1m |
| timeStart   | long         | 事件开始时间 | -          |
| timeEnd     | long         | 事件结束时间 | -          |
| priority    | int          | 优先级       | -          |
| alertPath   | [Position3D] | 预警路径     | 列表       |
| referLink   | [int]        | 相关车道     | 列表       |

类型名：Position3D

| 属性名 | 类型 | 属性 | 备注                                                         |
| ------ | ---- | ---- | ------------------------------------------------------------ |
| lat    | int  | 纬度 | 纬度，LSB=0.1微度，提供一个加减范围                          |
| lon    | int  | 经度 | 纬度，LSB=0.1微度，提供一个加减范围                          |
| ele    | int  | 高度 | 海拔高度，单位时参考椭圆上下方10cm， 范围-409.5~+6143.9m 当未知数据出现时，赋值-4096 |

### 5.2 TrafficSign

类型名：TrafficSign

| 属性名      | 类型         | 属性         | 备注     |
| ----------- | ------------ | ------------ | -------- |
| signId      | string       | 标志标线id   | -        |
| signType    | int          | 标志标线类型 | -        |
| signPos     | Pos3         | 标志标线位置 | -        |
| description | string       | 描述         | -        |
| timeStart   | long         | 开始时间     | -        |
| timeEnd     | long         | 结束时间     | -        |
| priority    | int          | 优先级       | -        |
| referPath   | [Position3D] | 相关路径     | -        |
| pathRadius  | int          | 路径半径     | 单位0.1m |
| referLink   | [int]        | 相关车道     | -        |

### 5.3 RoadSideInformation

类型名：RoadSideInformation

| 属性名      | 类型                | 属性       | 备注                                                         |
| ----------- | ------------------- | ---------- | ------------------------------------------------------------ |
| timeStamp   | int                 | 时间戳     | 一年中的分钟，无效时输入527040                               |
| id          | string              | id         | RSU ID（大小（8））                                          |
| rsiId       | int                 | rsi 编号   | 通过RSU建立rsi 信息的本地id（0..255）                        |
| alertType   | int                 | 警告类型   | 参考GB 5768.2或 GBT 29100-2012，事故预警或者交通标志类型     |
| description | string              | 描述       | IA5字符串（大小（1..256）），alterType=0时消息警告，alterType>0时交通标志等警告 |
| priority    | string              | 优先级     | 优先级。与此类型的相似信息比较后的相对程度（不是这个装置发送的其他信息），也不是紧急程度的优先级。低五位保留置0，B00000000到B11100000代表最低到最高级别。 |
| refPos      | Position3D          | 参考点位置 | 交通警告消息的位置（交通标志或者事件）                       |
| alertPath   | [PositionOffsetLLV] | 预警路径   | Msg_RSI信息路径点列表，如果车辆行驶在该路径，警告激活，沿车辆行驶方向由近到远列出点，一条路径至少包含两个点。 |
| alertRaduis | int                 | 预警半径   | 路侧预警消息的半径，(0..1024),单位时0.1m                     |

类型名： PositionOffsetLLV

| 属性名         | 类型                   | 属性           | 备注                                                         |
| -------------- | ---------------------- | -------------- | ------------------------------------------------------------ |
| offsetLLChoice | PositionOffsetLLChoice | 相对经纬度类型 | positionLL1=0, positionLL2=1, postitionLL3=2, psotitionLL4=3, positionLL5=4, positionLL6=5, positionLatLon=6, |
| offsetLL       | PositionOffsetLL       | 相对经纬度     | 相对lon/lat                                                  |
| offsetVChoice  | VerticalOffsetChoice   | 相对高度类型   | offset1=0, offset2=1, offset3=2,  offset4=3, offset5=4, elevation=6 |
| offsetV        | VerticalOffset         | 相对高度       | 相对高度                                                     |

类型名：VerticalOffset

以下变量均低于或高于参考椭圆球10cm

| 属性名    | 类型 | 属性      | 备注                                           |
| --------- | ---- | --------- | ---------------------------------------------- |
| offset1   | int  | 相对高度1 | VertOffsetB07，范围是+-6.3m                    |
| offset2   | int  | 相对高度2 | VertOffsetB08，LSB，单位10cm，范围+-12.7m      |
| offset3   | int  | 相对高度3 | VertOffsetB09，LSB,   单位10cm，范围+-25.5m    |
| offset4   | int  | 相对高度4 | VertOffsetB10,   LSB,  单位10cm，范围+-51.m    |
| offset5   | int  | 相对高度5 | VertOffsetB11,   LSB,  单位10cm，范围+-102.3.m |
| offset6   | int  | 相对高度6 | VertOffsetB12,   LSB,  单位10cm，范围+-204.7.m |
| elevation | int  | 高度      | Elevation，LSB, 单位10cm，范围-409.5~+6143.9m  |

类型名：PositionOffsetLL

当使用相对位置时，相对经纬度包含了跨越赤道的情况

| 属性名         | 类型            | 属性        | 备注 |
| -------------- | --------------- | ----------- | ---- |
| positionLL1    | PositionLL24B   | 相对经纬度1 | -    |
| positionLL2    | PositionLL28B   | 相对经纬度2 | -    |
| positionLL3    | PositionLL32B   | 相对经纬度3 | -    |
| positionLL4    | PositionLL36B   | 相对经纬度4 | -    |
| positionLL5    | PositionLL44B   | 相对经纬度5 | -    |
| positionLL6    | PositionLL48B   | 相对经纬度6 | -    |
| positionLatLon | PositionLLmD46b | 经纬度      | -    |

类型名：PositionLLmD64b
一个Lat/Lon完整32b的范围，LSB单位为0.1微度

| 属性名 | 类型 | 属性 | 备注 |
| ------ | ---- | ---- | ---- |
| lon    | int  | 经度 | -    |
| lat    | int  | 纬度 | -    |

类型名：PositionLL48B
范围+-0.8388607度，赤道范围+-92.754681千米，LSB单位为0.1微度

| 属性名 | 类型 | 属性     | 备注 |
| ------ | ---- | -------- | ---- |
| lon    | int  | 相对经度 | -    |
| lat    | int  | 相对纬度 | -    |

类型名：PositionLL44B
范围+-0.2097151度，赤道范围+-23.189096千米，LSB单位为0.1微度

| 属性名 | 类型 | 属性     | 备注 |
| ------ | ---- | -------- | ---- |
| lon    | int  | 相对经度 | -    |
| lat    | int  | 相对纬度 | -    |

类型名：PositionLL36B
范围+-0.0131071度，赤道范围+-01.449308千米，LSB单位为0.1微度

| 属性名 | 类型 | 属性     | 备注 |
| ------ | ---- | -------- | ---- |
| lon    | int  | 相对经度 | -    |
| lat    | int  | 相对纬度 | -    |

类型名：PositionLL32B
范围+-0.0032767度，赤道范围+-362.31873米，LSB单位为0.1微度

| 属性名 | 类型 | 属性     | 备注 |
| ------ | ---- | -------- | ---- |
| lon    | int  | 相对经度 | -    |
| lat    | int  | 相对纬度 | -    |

类型名：PositionLL 28B
范围+-0.008191度，赤道范围+-90.571389米，LSB单位为0.1微度

| 属性名 | 类型 | 属性     | 备注 |
| ------ | ---- | -------- | ---- |
| lon    | int  | 相对经度 | -    |
| lat    | int  | 相对纬度 | -    |

类型名：PositionLL 24B
范围+-0.0002347度，赤道范围+-22.634566b米，LSB单位为0.1微度

| 属性名 | 类型 | 属性     | 备注 |
| ------ | ---- | -------- | ---- |
| lon    | int  | 相对经度 | -    |
| lat    | int  | 相对纬度 | -    |

### 5.4 RoadsideSafetyMessage

类型名：VehicleSize

| 属性名 | 类型 | 属性 | 备注                                    |
| ------ | ---- | ---- | --------------------------------------- |
| width  | int  | 宽度 | 整数（0..1023）,LSB单位1cm，范围>10m    |
| length | int  | 长度 | (0..4095), LSB单位1cm，范围>40m         |
| height | int  | 高度 | 整数(0..127)，LSB单位为5cm，范围到6.35m |

类型名：AccelerationSet4Way

| 属性名 | 类型 | 属性 | 备注                                                         |
| ------ | ---- | ---- | ------------------------------------------------------------ |
| long   | int  | 纵向 | 沿车辆纵向坐标，整数（-2000，2001）,LSB单位时0.01m/s^2^,大于2000的值应使用2000 的值，小于-2000的值应使用值-2000，不可用的值应使用值2001。 |
| lat    | int  | 横向 | 沿车辆横向轴，整数（-2000..2001）,LSB单位为0.01m/s^2^，大于2000的值应使用2000 的值，-2000也会用到。 |
| vert   | int  | 垂直 | 沿车辆垂直坐标，,LSB单位时0.01m/s^2^,大于2000的值应使用2000 的值，-2000也能使用。 |
| yaw    | int  | 偏移 | 偏移率，整数（-32767…32767）,LSB单位每秒0.01度（标记）       |

类型名： PositionConfidenceSet

| 属性名    | 类型 | 属性       | 备注                     |
| --------- | ---- | ---------- | ------------------------ |
| pos       | int  | 水平置信度 | 水平两个方向的位置置信度 |
| elevation | int  | 高度置信度 | 高度置信度               |

类型名：MotionConfidenceSet

| 属性名     | 类型 | 属性       | 备注 |
| ---------- | ---- | ---------- | ---- |
| speedCfd   | int  | 速度置信度 | enum |
| headingCfd | int  | 航向置信度 | enum |
| steerCfd   | int  | 转向置信度 | enum |

类型名： ParticipantData

| 属性名       | 类型                  | 属性     | 备注                                                         |
| ------------ | --------------------- | -------- | ------------------------------------------------------------ |
| ptcType      | int                   | ptc类型  | -                                                            |
| ptcID        | int                   | ptcID    | RSU设置的临时ID，0为RSU本身，1…255代表RSU检测到参与者        |
| source       | int                   | 来源     | 未知（0），自己信息（1），v2x（2），v2x，视频（3），微波雷达（4），线圈（5） |
| id           | string                | id       | 八字节字符串（大小（8））可选                                |
| plateNo      | string                | 车牌     | 八字节字符串（大小（4..16））可选                            |
| secMark      | int                   | 秒       | D秒，以毫秒为单位                                            |
| pos          | PositionOffsetLLV     | 位置     | -                                                            |
| accuracy     | PositionConfidenceSet | 准确度   | -                                                            |
| transmission | int                   | 传输     | -                                                            |
| speed        | int                   | 速度     | 整数（0..8191),单位0.02m/s,8191意味着速度无效                |
| heading      | int                   | 航向     | LSB的0.0125度，范围0~359.9875度                              |
| angle        | int                   | 角度     | LSB单位为1.5度，范围为-189至+189度，+001=+1.5度，-126=-189度及以上，+126=+189度及以上，+127用于不可用 |
| motionCfd    | MotionConfidenceSet   | 动力Cfd  |                                                              |
| accelset     | AccelerationSet4Way   | 加速度   |                                                              |
| size         | VehicleSize           | 尺寸     | -                                                            |
| vehicleClass | int                   | 车辆分类 | 基础车辆分类，整数（0..255）                                 |

类型名：RoadsideSafetyMessage

| 属性名       | 类型              | 属性       | 备注                          |
| ------------ | ----------------- | ---------- | ----------------------------- |
| id           | string            | id         | RSU ID                        |
| refPos       | Position3D        | 参考点位置 | Msg_RSM信息参考位置           |
| participants | [ParticipantData] | 参与者     | RSU检测到所有或者部分参与设备 |

### 5.5 SafetyMessage

类型名：PositionConfienceSet

| 属性名    | 类型                | 属性       | 备注                                                         |
| --------- | ------------------- | ---------- | ------------------------------------------------------------ |
| pos       | PositionConfidence  | 位置置信度 | 水平两个方向的位置置信度 unavailable=0,a500m=1,a200m=2,  a100m=3,a50m=4,a20m=5,a10m=6, a5m=7,a2m=8,a1m=9,a50cm=10, a20cm=11,a10cm=12,a5cm=13, |
| elevation | ElevationConfidence | 高度置信度 | 高度置信度 unavailable=0,elev50000=1, elev20000=2,elev10000=3, elev05000=4,elev02000=5, elev01000=6,elev00500=7, elev00200=8,elev00100=9, elev0050=10,elev0020=11, |

类型名：MotionConfidenceSet

| 属性名     | 类型                         | 属性    | 备注                                                         |
| ---------- | ---------------------------- | ------- | ------------------------------------------------------------ |
| speedCfd   | SpeedConfidence              | 速度Cfd | unavailable=0，prec100ms=1，prec10ms=2，prec5ms=3，prec1ms=4，prec0_1ms=5,prec0_05ms=6,prec0_01ms=7 |
| headingCfd | HeadingConfidence            | 航向Cfd | unavailable=0,prec10deg=1, prec05deg=2,prec01deg=3, prec0_1deg=4,prec0_05deg=5, prec0_01deg=6,prec0_0125deg=7 |
| steerCfd   | SteeringWheelAngleConfidence | 转向Cfd | unavailable=0,prec2deg=1, prec1deg=2,prec0_02deg=3           |

类型名：VehicleSafetyExtensions

| 属性名 | 类型              | 属性 | 备注                                                         |
| ------ | ----------------- | ---- | ------------------------------------------------------------ |
| events | VehicleEventFlags | 事件 | eventHazardLights=0， evenStoplineViolation=1， eventABSactivated=2，eventTractionControlLoss=3, eventStabilityControlactivated=4, eventHazardousMaterials=5， eventReserved1=6, eventHardBraking=7, eventLightsChanged=8, eventWipersChanged=9, eventFlatTire=10, eventDisabledVehicle=11, eventAirbagDeployment =12 |
| lights | ExteriorLights    | 灯光 | lowBeamHeadlightsOn=0, highBeamHeadlightsOn=1, leftTurnSignalOn=2, rightTurnSignalOn=3, hazardSignalOn=4, automaticLightControlOn=5, daytimeRunningLightsOn=6, fogLightOn=7, parkingLightsOn=8 |

类型名：BarkeSystemStatus

| 属性名      | 类型                   | 属性           | 备注                                                         |
| ----------- | ---------------------- | -------------- | ------------------------------------------------------------ |
| brakePadel  | BrakePedalStatus       | 刹车盘         | unavailable=0,   off=1,       on=2                           |
| wheelBrakes | BrakeAppliedStatus     | 车轮制动器     | unavailable=0,leftFront=1, rightRear=4，leftRear=2,rightFront=3, |
| traction    | TractionControlStatus  | 牵引           | unavailable=0,off=1,on=2, engaged=3                          |
| abs         | AntiLockBrakeStatus    | 防抱死制动系统 | unavailable=0,off=1, on=2,engaged=3                          |
| scs         | StabilityControlStatus | 稳定控制状态   | unavailable=0,off=1, on=2,engaged=3                          |
| brakeBoost  | BrakeBoostApplied      | 制动推动器     | unavailable=0,off=1, on=2,engaged=3                          |
| auxBrakes   | AuxiliaryBrakeStatus   | 辅助制动器     | unavailable=0,off=1, on=2,engaged=3                          |

类型名：ReferPosition
以雷达为原点的坐标系中的相对位置

| 属性名    | 类型 | 属性    | 备注                                   |
| --------- | ---- | ------- | -------------------------------------- |
| deviceId  | int  | 设备id  | 检测设备                               |
| positionX | int  | X轴坐标 | 单位0.01m，雷达法线方向为 x 轴         |
| positionY | int  | Y轴坐标 | 单位0.01m，垂直雷达法线的左方向为 y 轴 |

类型名：SafetyMessage

| 属性名          | 类型                    | 属性         | 备注                                                         |
| --------------- | ----------------------- | ------------ | ------------------------------------------------------------ |
| ptcType         | string                  | ptc类型      | 参与者类型                                                   |
| ptcId           | string                  | ptc id       | 参与者id                                                     |
| source          | string                  | 来源         | -                                                            |
| plateNo         | string                  | 凭证         | 车牌                                                         |
| secMark         | int                     | sec标志      | DSecond，单位是毫秒                                          |
| pos             | Position3D              | 位置         | -                                                            |
| referPos        | ReferPosition           | 相对位置     | -                                                            |
| laneId          | int                     | 所在车道     | -                                                            |
| accuracy        | PositionConfidenceSet   | 精确度       | -                                                            |
| transmission    | TransmissionState       | 传输         | -                                                            |
| speed           | int                     | 速度         | 整数（0，8191），单位0.02m/s，8191指代速度值无效             |
| heading         | int                     | 航向         | LSB0.0125度，范围0~359.9875度                                |
| angle           | int                     | 角度         | LSB单位1.5度，范围为-189至+189度，+001=+1.5度，-126=-189度及以上，+126=+189度及以上，+127用于不可用 |
| motionCfd       | MotionConfidenceSet     | Cfd运动      | -                                                            |
| acclset         | AccelerationSet4Way     | 加速度计     | -                                                            |
| brakes          | BrakeSystemStatus       | 制动状态     | -                                                            |
| size            | VehicleSize             | 尺寸         | -                                                            |
| vehicleClass    | int                     | 车辆分类     | 车辆分类包括基本类型和其他类型                               |
| safetyExt       | VehicleSafetyExtensions | 车辆安全拓展 | -                                                            |
| driverBehavior  | string                  | 驾驶行为     | 分心，违法…                                                  |
| laneChangingAim | int                     | 变道瞄准     | -                                                            |

### 5.6 DensityLane

类型名：DensityLane

| 属性名         | 类型       | 属性           | 备注                                               |
| -------------- | ---------- | -------------- | -------------------------------------------------- |
| deviceId       | string     | 装置ID         | -                                                  |
| detectStartPos | Position3D | 检测开始时位置 | -                                                  |
| detectEndPos   | Position3D | 检测结束时位置 | -                                                  |
| timeStamp      | int        | 时间戳         | 一年中每一分钟，整数（0..527040）,无效时输入527040 |
| laneNo         | int        | 车道号         | -                                                  |
| density        | int        | 密度           | -                                                  |

### 5.7 SpeedLaneArea

类型名：SpeedLaneArea

| 属性名         | 类型       | 属性           | 备注                                             |
| -------------- | ---------- | -------------- | ------------------------------------------------ |
| deviceID       | string     | 检测器id       | -                                                |
| detectStartPos | Position3D | 检测开始的位置 | -                                                |
| detectEndPos   | Position3D | 检测结束的位置 | -                                                |
| timeStamp      | int        | 时间戳         | 年每一分钟，整数（0.527040），527040被用作无效值 |
| laneNo         | int        | 车道号         | -                                                |
| speed          | int        | 速度           | 整数（0..8191），单位0.02m/s，8191意味着无效值   |

### 5.8 SpeedLanePoint

类型名：SpeedLanePoint

| 属性名    | 类型       | 属性     | 备注                                            |
| --------- | ---------- | -------- | ----------------------------------------------- |
| deviceID  | string     | 装置ID   | -                                               |
| detectPos | Position3D | 检测位置 | -                                               |
| timeStamp | int        | 时间戳   | 年每一分钟，整数（0.527040） 527040被用作无效值 |
| cycle     | int        | 周期     | -                                               |
| laneNo    | int        | 车道数   | -                                               |
| speed     | int        | 速度     | 整数（0..8191），单位0.02m/s 8191意味着无效值   |

### 5.9 VolumeLane

类型名：VolumeLane

| 属性名    | 类型       | 属性     | 备注 |
| --------- | ---------- | -------- | ---- |
| deviceID  | string     | 装置ID   | -    |
| detectPos | Position3D | 检测位置 | -    |
| timeStamp | long       | 采样时间 | -    |
| cycle     | int        | 周期     | -    |
| laneNo    | int        | 车道号   | -    |
| volume    | int        | 流量     | -    |

### 5.10 Map

类型名：RegulatorySpeedLimit

| 属性名 | 类型           | 属性 | 备注                                                         |
| ------ | -------------- | ---- | ------------------------------------------------------------ |
| type   | SpeedLimitType | 类型 | unknown=0，maxSpeedInSchoolZone=1，maxSpeedInSchoolZoneWhenChildrenArePresent=2,maxSpeedInConstructionZone=3,  vehicleMinSpeed=4,vehicleMaxSpeed=5,vehicleNightMaxSpeed=6，truckMinSpeed=7, truckMaxSpeed=8,truckNightMaxSpeed=9,vehiclesWithTrailersMinSpeed=10, vehiclesWithTrailersMaxSpeed=11,vehiclesWithTrailersNightMaxSpeed=12 |
| speed  | int            | 速度 | 速度的单位是0.02米/秒。参见第11节的换算和转换，速度以m/s为单位 |

类型名：RoadPoint

| 属性名    | 类型              | 属性     | 备注               |
| --------- | ----------------- | -------- | ------------------ |
| posOffset | PositionOffsetLLV | 相对位置 | 参考位置的相对位置 |

类型名： NodeReferenceID

| 属性名 | 类型 | 属性 | 备注                                                         |
| ------ | ---- | ---- | ------------------------------------------------------------ |
| region | int  | 区域 | 0~65535随机整数，0仅作为测试需要，全球每一区域只赋值一个，优先派给区域DOT |
| id     | int  | id   | 0~65535之间随机整数，在上述区域中，讨论与区域节点的映射关系  |

类型名：Movement

| 属性名             | 类型            | 属性         | 备注                                                         |
| ------------------ | --------------- | ------------ | ------------------------------------------------------------ |
| remoteIntersection | NodeReferenceID | 远方十字路口 | 表示沿行驶方向，与该车道连接的十字路口                       |
| phaseId            | int             | 相位ID       | 该车道/机动的SPAT信息发送的匹配信号组。 除非连接车道没有信号组（无信号） |

类型名：ConnectingLane

| 属性名   | 类型 | 属性 | 备注                 |
| -------- | ---- | ---- | -------------------- |
| lane     | int  | 车道 | 列表里已连接的车道   |
| maneuver | int  | 方向 | 在车道和该车道停止线 |

类型名：Connection

| 属性名             | 类型            | 属性         | 备注                                                         |
| ------------------ | --------------- | ------------ | ------------------------------------------------------------ |
| remoteIntersection | NodeReferenceID | 远方十字路口 | 指示与车道相连的十字路口，这提供了建立车道网格的方法         |
| connectingLane     | ConnectingLane  | 连接车道     | 连接道路的索引，又或者时从当前车道移动到下一个t0列表上允许连接的车道上，我们使用 |
| phaseid            | int             | 相位id       | 该车道/机动的SPAT信息发送的匹配信号组。 除非连接车道没有信号组（无信号） |

类型名： LaneTypeAttributes

| 属性名    | 类型 | 属性     | 备注           |
| --------- | ---- | -------- | -------------- |
| vehicle   | int  | 车辆     | 包括摩托车     |
| crosswalk | int  | 斑马线   | 人行横道       |
| bikeLane  | int  | 自行车道 | 自行车车道     |
| sidewalk  | int  | 人行道   | 人行道         |
| median    | int  | 中间带   | 中间带或绿化带 |
| striping  | int  | 条带     | 道路标线       |
| tracked   | int  | 铁轨     | 火车和手推车   |
| parking   | int  | 停车     | 停车或者停车线 |

类型名： LaneAttributes

| 属性名    | 类型               | 属性     | 备注                                                         |
| --------- | ------------------ | -------- | ------------------------------------------------------------ |
| shareWith | LaneSharing        | 共享     | overlappingLaneDescriptionProvided=0，multipleLanesTreatedAsOneLane=1,otherNonMotorizedTrafficTypes=2, individualMotorizedVehicleTraffic=3,busVehicleTraffic=4,taxiVehicleTraffic=5, pedestriansTraffic=6,cyclistVehicleTraffic=7,trackedVehicleTraffic=8, pedestrianTraffic=9 |
| laneType  | LaneTypeAttributes | 车道类型 | -                                                            |

类型名：Lane

| 属性名         | 类型                   | 属性     | 备注                                                         |
| -------------- | ---------------------- | -------- | ------------------------------------------------------------ |
| laneID         | int                    | 车道iD   | 整数（0。。255），当车道ID不可用或未知时，应使用0。255保留供将来使用 |
| laneAttributes | LaneAttributes         | 车道属性 |                                                              |
| maneuvers      | int                    | 方向     |                                                              |
| connectsTo     | [Connection]           | 连接     | 列表                                                         |
| speedLimits    | [RegulatorySpeedLimit] | 限速     |                                                              |
| points         | [RoadPoint]            | 点       |                                                              |

类型名：Link

| 属性名         | 类型                   | 属性     | 备注                 |
| -------------- | ---------------------- | -------- | -------------------- |
| name           | string                 | 名称     | 路段名               |
| upstreamNodeId | NodeReferenceID        | 上游节点 | -                    |
| speedLimits    | [RegulatorySpeedLimit] | 限速     | 列表                 |
| laneWidth      | int                    | 路段宽度 | 0~32767整数，单位1cm |
| points         | [RoadPoint]            | 点       | 列表                 |
| movements      | [Movement]             | 方向     | 列表                 |
| lanes          | [Lane]                 | 车道     | 列表                 |

类型名：Node

 节点可以是交叉点，也可以是道路终点 

| 属性名  | 类型            | 属性     | 备注                                               |
| ------- | --------------- | -------- | -------------------------------------------------- |
| name    | string          | 名称     | 节点名称                                           |
| id      | NodeReferenceID | id       | 全球唯一值集合，由区域和节点id组成                 |
| refPos  | Position3D      | 参考位置 | 中心的三维位置节点。这个位置也是内部元素的参考位置 |
| inLinks | [Link]          | 路段     | 所有的路段都进入这个节点                           |

类型名：Map

| 属性名   | 类型   | 属性   | 备注                                             |
| -------- | ------ | ------ | ------------------------------------------------ |
| timeSamp | long   | 时间戳 | 年中每一分钟，0~527040中的整数，无效时填写527040 |
| nodes    | [Node] | 节点   | 列表                                             |

### 5.11 SignalPhaseAndTiming

类型名：TimeChangeDetails

| 属性名         | 类型 | 属性           | 备注                                                         |
| -------------- | ---- | -------------- | ------------------------------------------------------------ |
| startTime      | int  | 开始时间       | 以UTC时间的1/10s为单位，当此阶段开始时，如果开始，此值为0    |
| minEndTime     | int  | 最小结束时间   | 预期最短结束时间，以UTC时间的1/10s为单位，如果已经启动，则该值是从现在开始最小剩余时间，如果未启动，则值表示该阶段最小长度 |
| maxEndTime     | int  | 最大结束时间   | 预期最短结束时间，以UTC时间的1/10s为单位，如果已经启动，则该值是从现在开始最大剩余时间，如果未启动，则值表示该阶段最大长度 |
| likelyEndTime  | int  | 可能结束时间   | 以UTC时间的1/10s为单位，基于其他数据的最佳预测值，如果已经开始，则值是从现在开始可能剩余的时间，如果未开始，则该值表示该阶段的可能长度 |
| timeConfidence | int  | 时间置信度     | 以UTC时间的1/10s为单位，表示可能结束时间的置信度             |
| nextStartTime  | int  | 下一次开始时间 | 以UTC时间的1/10s为单位，此状态下次可能发生时间的粗略估计，在上述结束时间之后，用于支持各种环保驱动电源管理需求。如果已经启动，建议传递此值。 |
| nextDuration   | int  | 下一个持续时间 | 以UTC时间的1/10s为单位，此状态下次可能结束时间的粗略估计，在上述结束时间之后，用于支持各种环保驱动电源管理需求。如果已经启动，建议传递此值。 |

类型名：PhaseState

| 属性名 | 类型              | 属性 | 备注                                                         |
| ------ | ----------------- | ---- | ------------------------------------------------------------ |
| light  | LightState        | 灯光 | 包括定向、保护、许可等11种基本状态 unavailable = 0,dark = 1，stopThenProceed = 2,stopAndRemain = 3, preMovement = 4,permissiveMovementAllowed = 5,protectedMovementAllowed = 6,  intersectionClearance = 7,cautionConflictingTraffic = 8 |
| timing | TimeChangeDetails | 时间 | 事件的UTC时间戳计时数据，包括阶段的开始时间和最小/最大结束时间，置信度和估计下次发生 |

类型名：Phase

| 属性名      | 类型         | 属性     | 备注                                                         |
| ----------- | ------------ | -------- | ------------------------------------------------------------ |
| id          | int          | id       | 组id用于映射到车道列表（及其描述），移动状态数据的使用 查看备注中有关用法详细信息的注释 |
| phaseStates | [PhaseState] | 阶段状态 | 列表，由一组变化数据组成，具有：a） 信号灯状态信息b）时间变化详细信息，以及c）建议速度（可选），未来的时间，允许传送多个信息。使用当前信号组来预测下一阶段和行驶时间。 |

类型名：IntersectionState

| 属性名         | 类型                     | 属性       | 备注                                                         |
| -------------- | ------------------------ | ---------- | ------------------------------------------------------------ |
| intersectionId | NodeReferenceID          | 十字路口id | 全球唯一值集（由区域ID和分配的交叉口id）提供唯一地图节点映射 |
| status         | IntersectionStatusObject | 状态       | 枚举，控制器的一般状态                                       |
| moy            | int                      | 分钟数     | 当前UTC年的分钟数，仅用于消息存档，使用值527040表示无效      |
| timeStamp      | int                      | 时间戳     | 以毫秒为单位，表示当前UTC分钟的毫秒点                        |
| phases         | [Phase]                  | 阶段       | 给出每个移动状态，并包含信号状态，映射到它所在车道以及它将结束的时间点，它可能包含移动状态和未来状态 |

类型名：SignalPhaseAndTiming

| 属性名        | 类型                | 属性   | 备注                                 |
| ------------- | ------------------- | ------ | ------------------------------------ |
| timeStamp     | long                | 时间戳 | 年中每一分钟，值527040将用于无效     |
| name          | string              | 名称   | 此集合的可读名称，仅在调试模式下使用 |
| intersections | [IntersectionState] | 交叉口 | SPAT数据集（每个交叉点一个）         |

### 5.12 DedicatedLaneControl

类型名：ControlScheme

| 属性名     | 类型 | 属性         | 备注     |
| ---------- | ---- | ------------ | -------- |
| id         | int  | id           | 方案id   |
| vmsId      | int  | 可变信息版id | -        |
| laneId     | int  | 车道id       | -        |
| laneType   | int  | 车道类型     | 专用道   |
| laneStatus | bool | 车道状态     | 是否开启 |

类型名： DedicatedLaneControl

| 属性名    | 类型            | 属性     | 备注                                             |
| --------- | --------------- | -------- | ------------------------------------------------ |
| timeStamp | long            | 时间戳   | 年中每一分钟，0~527040中的整数，无效时填写527040 |
| schemes   | [ControlScheme] | 方案列表 | 列表                                             |

### 5.13 RampMetering

类型名：RMScheme

| 属性名       | 类型 | 属性     | 备注   |
| ------------ | ---- | -------- | ------ |
| id           | int  | id       | 列表id |
| rampId       | int  | 斜坡id   | -      |
| signalHeadId | int  | 信号灯id | -      |
| cycle        | int  | 周期     | 单位s  |
| green        | int  | 红灯     | 单位s  |
| red          | int  | 绿灯     | 单位s  |

类型名：SignalPhase

| 属性名        | 类型 | 属性           | 备注     |
| ------------- | ---- | -------------- | -------- |
| id            | int  | id             | 信号灯id |
| phaseStatus   | int  | 阶段状态       | -        |
| nextGreenTime | int  | 下一个绿灯时间 | 单位s    |

类型名：RampMetering

| 属性名    | 类型          | 属性     | 备注                                             |
| --------- | ------------- | -------- | ------------------------------------------------ |
| timeStamp | int           | 时间戳   | 年中每一分钟，0~527040中的整数，无效时填写527040 |
| schemes   | [RMScheme]    | 方案列表 | -                                                |
| phases    | [SignalPhase] | 相位     | 列表                                             |

### 5.14 VariableSpeedLimit

类型名：SpeedLimitScheme

| 属性名             | 类型 | 属性       | 备注       |
| ------------------ | ---- | ---------- | ---------- |
| speedLimitSchemeId | int  | 限速列表id | km/h       |
| laneId             | int  | 道路id     | -          |
| vmsId              | int  | vms id     | -          |
| speedLimit         | int  | 限速       | -          |
| speedLimitTime     | int  | 限速时间   | 速度、分钟 |

类型名：VariableSpeedLimit 

| 属性名    | 类型               | 属性   | 备注                             |
| --------- | ------------------ | ------ | -------------------------------- |
| timeStamp | int                | 时间戳 | 年中每一分钟，值527040将用于无效 |
| schemes   | [SpeedLimitScheme] | 方案   | 列表                             |

## 六、路侧单元通信API

本类型构造了一个与单个路侧通信设备实时交互的工具，主要功能包括监听和发送两部分。

1. 监听：构造一个监听线程获取固定Ip和Port发送来的信息（主要包括V2x信息，V2X信息主要覆盖BSM消息），同时将信息转换为对应的FBS消息向上层发送
2. 发送：将上层下发的信息打包为V2x信息，通过传输协议发送至已经开放协议栈的Rsu，Rsu打开传输协议并将内部V2x信息进行转发广播，实现Rsu的控制。

### 6.1 流程

1. 初始化新的路侧设备
   调用
   RoadSideUnit(ushort Rport, char *Rip, ushort Sport, char* Sip, std::string id,int Interval);
   功能：初始化一个新的RSU类型
   输入参数：接收的端口，接口的ip，发送的端口，发送的ip，设备ID和训调的周期
   输出参数：失败则会抛出异常
2. 发送消息
   调用
   int RoadSideUnit::SendV2XMsg(void *data, const long data_type, size_t size)
   功能：将FBS消息转换为V2X消息发送出去
   输入参数：FBS消息指针，FBS数据类型和FBS数据大小
   输出参数：RSU发送成功则会返回1，发送失败则返回0
3. 接收消息
   调用
   int ReceiveRSUMsgShared(shared_ptr flatbuffer,size_t size, int type)
   功能：将V2X消息转换为FBS消息发送至接口层
   输入参数：FBS消息指针，FBS数据大小和FBS数据类型
   输出参数：RSU发送成功则会返回1，发送失败则返回0
4. 关闭当前路侧设备
   调用
   void CloseRSU();
   功能：将当前路侧通信设备实例关闭

## 七、路侧MEC软件架构说明

### 7.1 基本开发环境

#### 7.1.1 软件

##### MEC设备环境

1. Ubuntu Server 16.04.7 LTS
2. GCC工具链 8.4.0
3. DBG
4. OpenSSH

##### Windows开发机环境

仅作推荐，不做强制要求：

1. Visual Studio 2019 (必须功能：C++ CMake tools for Windows，增加功能请用Visual Studio Installer修改安装)

使用Visual Studio 2019进行远程开发的具体操作过程见[这里](https://docs.microsoft.com/zh-cn/cpp/build/cmake-projects-in-visual-studio?view=msvc-160)。

#### 7.1.2 硬件

##### 实验室开发板

本软件基于研扬Up Xtreme开发板进行开发，搭载CPU型号为i7-8665UE，16G DDR4内存、64G eMMC储存，后续将通过SATA接口挂载6T或以上硬盘储存数据。
其它具体对外物理接口和参数如下（摘自UP Xtreme Datasheet）：

![up1.png](https://i.loli.net/2021/01/28/jVZcK9houDCFkpg.png)

![up2.png](https://i.loli.net/2021/01/28/VUSLz2JNgO4Znld.png)

##### 服务器

由于实验室开发板处于内网环境，为方便调试，设置了腾讯云上海四区公网服务器，其基本开发环境配置与开发板基本相同。请提前向文档作者申请ssh账号，用于登录及远程调试。

- 域名：phi.ctcat.cn
- IP：121.4.136.4

### 7.2 MEC软件架构

MEC软件主要由数据处理、应用服务、数据发送和本地控制4个基本模块组成，基本关系如下图所示：

![mec_framework.png](https://i.loli.net/2021/01/28/wHguMhtLsm42zlX.png)

#### 7.2.1 数据处理模块

- 数据处理与汇聚 ：汇聚云端下发指令和数据、雷视数据融合的结果及RSU返回的车辆数据，进行结构化。

#### 7.2.2 数据接口模块

- 数据库：对视频数据和车辆轨迹数据保存一定期限（如30日），过期数据定期清理；
- 通用数据接口：基于数据库所储存的数据，为应用服务模块提供统一的通用数据接口，支撑具体业务开展。

#### 7.2.3 应用服务模块

- MEC应用服务调用：根据业务逻辑，按照当前开放应用列表（可更新）调用各应用模块，并通过通用数据接口获取各应用所需的数据；
- 应用：每一个应用是一个.so库，由本模块按照当前开放应用列表（可更新）进行加载；统一接口形式，输入结构化数据，决策当前应用是否被触发，并输出控制变量，即后续待发送的消息。
- 优先级控制：获取各个应用.so库输出的控制指令并对优先级进行判别，分发当下控制指令；
- 溢出控制：抛弃消息发送队列中不能在规定时延要求内发送的消息，满足时延性能要求；

#### 7.2.4 数据发送模块

- 设备控制：根据优先级控制输出指令对各外接设备进行控制，实现交通控制。

#### 7.2.5 本地控制模块

- 控制上述4模块的启动和关闭；
- 根据云端发送的更新指令，对各模块代码、配置文件和.so库文件进行更新；
- 监控上述4模块的运行状态，及时处理错误、异常、崩溃等事件，保障服务连续可用性；
- 日志。

## 八、MEC硬件设备交互

### 8.1 交互逻辑

#### 8.1.1 MEC -> SO

MEC主体软件向so库传递MECData数据结构，包含以下信息：

- MEC设备本身的ID、所在位置和运行状态；
- MEC所连接的所有外设的类型、ID、位置、检测范围/广播范围（如适用）、实时运行状态。

MECData数据结构包含的信息和具体定义见[附录对应内容](http://108.61.183.243/project/3/post/26#MECData数据结构)。

MECData数据结构传递到so库的时机包括：

- so库初始化；
- MEC设备或连接外设的信息发生变化，需要通知so库。

其他时候，so库不会收到MECData数据结构输入。如需要与外设交互，为了实现上述逻辑，so库对应json配置文件中，应当在初始化和业务循环两个阶段均声明MECData数据结构输入。

#### 8.1.2 SO -> MEC

SO输出数据，需要通过Get()函数中的string_value参数指明该结构体应当被传输到的设备ID，可以传递给MEC设备本身，也可以传递到MEC连接的硬件外设。
设备ID由MEC自动分配，SO库内部直接读取并利用即可。设备ID编号规则见[附录对应内容](http://108.61.183.243/project/3/post/26#设备ID规则)。
【例】若需要向车辆广播RSI消息，则应当把so库生成的RSI结构体发送到ID为"RSU_0"的外设。

### 8.2 附录

#### 8.2.1 设备ID规则

设备ID为字符串类型，格式：[设备类别前缀]+"_"+[十进制数字]。

| 设备类别         | 前缀      |
| :--------------- | :-------- |
| 本地MEC          | "LOCAL"   |
| 其他MEC          | "MEC"     |
| RSU              | "RSU"     |
| 雷达             | "RADAR"   |
| 视频             | "VIDEO"   |
| 可变情报板       | "VMS"     |
| 信号控制机       | "SIGNAL"  |
| 云平台           | "CLOUD"   |
| 本地设备管理后台 | "CONSOLE" |
| 其他             | "OTHERS"  |

数字部分，由MEC主体程序根据外设注册先后顺序自动分配。

#### 8.2.2 MECData数据结构

- MECData.fbs：MECData数据结构根节点。

```c
include "Position3D.fbs";
include "DeviceAbnormal.fbs";
include "DeviceInfo.fbs";
namespace MECData;
table MSG_MECInfo {
    id:string;                                         //MEC id
    pos:DF_Position3D;
    status:DF_DeviceAbnormal;
    deviceManage:[DF_DeviceInfo];
}
root_type MSG_MECInfo;
```

- DeviceInfo.fbs：MEC外设基本信息。

```c
include "Position3D.fbs";
include "DeviceAbnormal.fbs";
namespace MECData;
table DF_DeviceInfo {
    id:string;                //other device id, eg: radar, video, rsu...
    deviceType:ubyte; 
    pos:DF_Position3D;
    direction:ubyte;          //normal direction, units of degree
    deviceRange:ubyte;        //units of m
    status:DF_DeviceAbnormal;
}
```

- DeviceAbnormal.fbs: MEC或者外设的实时运行状态和故障信息。

```c
namespace MECData;
table DF_DeviceAbnormal {
    state:ubyte;
    abnormalType:ubyte;
    descrption:string;
}
```

- Position3D.fbs: 设备所在经纬度和海拔。

```c
    namespace MECData;
    struct DF_Position3D {
        lat:int;        //Latitude,LSB = 1/10 micro degree,Providing a range of plus-minus 90 degrees
        lon:int;        //Longitude,LSB = 1/10 micro degree,Providing a range of plus-minus 180 degrees
        ele:short;      //Elevation,units of 10 cm steps above or below the reference elli psoid,Provid ing a range of - 409.5 to + 6143.9 meters,The value -4 096 shall be used when Unknown is to be sent
    }
```

数据结构中类型与状态等可能取值见[相关定义](http://108.61.183.243/project/3/post/26#外设类别、运行状态和异常类型等定义)。

#### 8.2.3 外设类别、运行状态和异常类型等定义

摘自mec_lib.h：

```c
    // 设备管理
    #define MAX_DEV_ID_SIZE 0x20u  // 设备ID字符串最大长度
    // 设备ID类别
    #define DEV_LOCAL 0x0u  // MEC自身
    #define DEV_MEC 0x1u    // 其它MEC
    #define DEV_RSU 0x2u
    #define DEV_RADAR 0x3u
    #define DEV_VIDEO 0x4u
    #define DEV_VMS 0x5u
    #define DEV_SIGNAL 0x6u
    #define DEV_CLOUD 0x7u
    #define DEV_CONSOLE 0xfeu   // 预留本机管理后台
    #define DEV_OTHERS 0xffu
    // 设备运行状态
    #define DEV_STATE_OK 0x0u
    #define DEV_STATE_OFF 0x1u  // 电源断开
    #define DEV_STATE_ABNORMAL 0x2u // 设备运行状态异常
    // 设备异常类型
    #define DEV_AB_OK 0x0u
    #define DEV_AB_POWER 0x1u   // 电源异常或断开
    #define DEV_AB_NETWORK 0x2u // 网络连接问题
    #define DEV_AB_ENV 0x3u     // 运行环境异常
    #define DEV_AB_FUNC 0x4u    // 设备功能异常
    #define DEV_AB_INTERR 0X5u  // 设备内部错误
    #define DEV_AB_UNKNOWN 0xffu    // 未知类型
```

## 九、so库提交标准流程

### 9.1 交付物

以下各项缺一不可：

1. so库源代码
2. 算法输入、输出及对应so库配置json文件
3. so库所用第三方库信息（名称、版本号、CMake Target或其他相关CMake指令，以及其他可以辅助联调测试的必要信息）
4. so库单元测试代码、算例数据
5. 算法功能及原理概要说明文档（由任务书、软件开发合同等法律文书所规定的，可直接交付其电子文档）

源代码及单元测试代码在开发环境下编译通过，并经由给定算例验证输出正确后，方可交付。

### 9.2 交付

算法so库交付通过GitHub代码库https://github.com/cantoncat/mec_libraries进行，具体形式为交付方向master分支发起Pull Request。

### 9.3 目录规范

下列项目需要放在指定的目录中，并规范命名：

1. so库源代码：/src
2. 算法输入、输出及对应so库配置json文件：/config
3. so库单元测试代码、算例数据：/test/[so库正式名称]，允许在此目录下使用子目录

上述1、3项涉及的源代码，要求完整编写各级目录的CMakeLists.txt，方便编译测试。

### 9.4 流程

1. 从master分支的HEAD commit新建分支，分支名称为so库名称
2. 把本地commit push到新的分支上，commit message要求[Angular规范](https://gist.github.com/brianclements/841ea7bffdb01346392c)
3. 发起Pull Request，除目录规范所涉及的3项内容外，其余交付物作为文字说明部分和文件附件，并assign给对接工程师
4. 对接工程师测试通过，通过Pull Request，merge到master分支
5. 完成

### 9.5 其他

- 所有代码和json配置文件要求UTF-8编码（Windows下开发尤其注意）
- 所有未完成或已完成的交付物均受保密协议约束，若fork了代码库，应注意设置为private，并在完成开发后删除

## 十、应用SO库接口说明

### 10.1 文件

- mec_lib.h: so库必须引用的头文件
- /includes/[数据结构名]_generated.h: 根据本so库的输入和输出结构体需求，按需包含在代码文件中
- [模块名].cpp: so库主程序文件
- [模块名].h: so库头文件（可选）
- apps.json: 全体so库列表
- [模块名].json: so库输入输出需求，按照mec_lib.h定义

### 10.2 接口

MEC so库共包含下列3个接口函数，功能和形参表含义见注释。主程序代码文件中，需要实现下列3个接口函数。函数原型已在mec_lib.h中定义。

```c
    // Summary: 向.so库输入指令
    // Return: ture: 成功
    //         false: 发生错误或不支持此命令
    extern "C" 
    bool Command(
        const long      command_type,       // 指令唯一标识符
        const long      long_value1,        // long parameter 1, 0 while not used
        const long      long_value2,        // long parameter 2, 0 while not used
        const double    double_value,       // double parameter, 0.0 while not used
        const char*     string_value,       // string parameter, NULL while not used
        const void*     void_value,         // parameter of other complex data structures, NULL while not used
        APP_ErrMsg*        app_errmsg          // error message
    );
    // Summary: 向.so库输入数据
    // Return: ture: 成功
    //         false: 发生错误或无此数据需求
    extern "C"
    bool Set(
        const long      data_type,          // 输入数据项唯一标识符
        const long      long_value1,        // long data 1, 0 while not used
        const long      long_value2,        // long data 2, 0 while not used
        const double    double_value,       // double data, 0.0 while not used
        const char*     string_value,       // string data, NULL while not used
        const void*     void_value,         // data of other complex data structures, NULL while not used
        APP_ErrMsg*     app_errmsg          // error message
    );
    // Summary: 向.so出输入数据
    // Return: ture: 成功
    //         false: 发生错误或当前无此输出
    extern "C" 
    bool Get(
        const long      data_type,          // 输出数据项唯一标识符
        long*           long_value1,        // int data 1
        long*           long_value2,        // int data 2
        double*         double_value,       // double data
        char*           string_value,       // string data, max length = 256 
        void*           void_value,            // parameter of other complex data structures
        APP_ErrMsg*     app_errmsg          // error message
    );
```

### 10.3 接口函数参数

接口函数参数中，除了第1个参数(xx_type)用于说明输入输出数据唯一标识符或者指令之外，其余参数根据该数据的类型调用，一般遵循下列规则：

- long_value1: Get()函数中表示标记结构体序号，从0起算，见void_value；
- long_value2: Set()和Get()函数中表示传入传出结构体大小，单位：byte；
- double_value: 浮点型数据传入或传出so；
- string_value: 字符串指针型数据传入或传出so；
- void_value：结构体型参数使用传入或传出so。so内部需要对(void*)型指针进行强制类型转换，并验证传入结构体类型无误之后再使用，否则必须报错；

注意：Get()函数中传入的实参是MEC软件中内存空间里的某个可写入空间的指针，输出数据时long、double型可以直接使用*long_value1=5语句赋值，char*和void*类型应使用strpcy()或memcpy()等函数进行拷贝

### 10.4 so库内部错误和异常反馈

接口函数中，app_errmsg参数的作用是返回so库中发生的内部错误或警告，定义如下：

```c
// APP_ErrMsg -- .so库反馈的错误、警告和调试信息
struct APP_ErrMsg
{
    unsigned int    err_id;             // err_id: to be defined
    char            err_msg[64];        // description
};
```

无论接口函数执行是否发生错误或异常，so均需要向err_id成员写入下列标准异常消息定义中的一个，必要时在err_msg字段中附上文字说明：

```c
// 错误与异常信息
// Under Construction
#define     MEC_E_SUCCEED                       0           // 操作成功
#define     MEC_E_END                           1           // 输出已结束
#define     MEC_E_NOT_NEEDED                    2           // 输入了当前不需要的数据
#define     MEC_E_INPUT_CORRUPTED               3           // 输入数据范围不合理
#define     MEC_E_STRUCT_CORRUPTED              4           // 结构体损坏或类型错误
#define     MEC_E_ALGO_FATAL                    5           // 算法运行出错，结果不可用
#define     MEC_E_ALGO_WARNING                  6           // 算法运行警告，结果可能不可用
#define     MEC_E_UNKNOWN                       7           // 内部未知错误
```

### 10.5 so库配置文件

so库所需的加载和输入输出配置，分别由apps.json和[模块名].json描述。

#### 10.5.1 apps.json

全体so库列表。每一个so库的信息是"apps"数组的一个元素。

```json
{
    "apps": [
        {
            "id": "2",
            "name": "2_rsi",
            "lib":  "2_rsi.so",
            "config": "2_rsi.json",
            "description": "Example app",
            "async": false,
            "priority": 200
        }
    ]
}
```

- id: so库唯一id
- name: so库名称（可选）
- lib: so库文件名
- config: so库配置文件名，推荐使用[模块名].json命名
- description: 对so库功能的描述（可选）
- async: 是否需要异步执行（若算法耗时较大或时效性要求低，设置为true，要求MEC软件为本so库单独开一个线程执行）
- priority: so库运行优先级，数字越小优先级越高

#### 10.5.2 [模块名].json

so库输入输出需求。

```json
{
    "id": "2",
    "init": [6480],
    "input": {
        "realtime": [5200],
        "history": [5217]
    },
    "output": [6273]
}
```

- id: so库唯一id
- init: 初始化阶段数据输入需求
- input: "realtime"数组列出需要输入的实时数据项，"history"数组列出需要通过Get()动态询问历史数据需求的数据项（只支持MEC_A_XX_DATAFRAME项，以结构体整体输入）
- output: 数据输出需求（计算结果）

需求数据项按照mec_lib.h定义，直接写.h文件中对应数字。例：需要输入MEC_A_TS_DATAFRAME，则根据mec_lib.h中的定义，在JSON中写作5456（原为0x1450，必须从16进制数转为10进制数），见下列代码：

```c
#define MEC_A_TS_DATAFRAME 0x1550u  // TrafficSign结构体整体输入
```

### 10.6 so库生命周期

![so_lifecycle_3.png](https://i.loli.net/2020/12/21/sHQ6x4Omz5IZVAk.png)

#### 10.6.1 初始化

so库被加载后，首先使用Command()输入初始化命令。

```c
// MEC软件一侧调用
bool bflag = Command(MEC_COMMAND_EXEC, 0, 0, 0.0, NULL, NULL, &app_errmsg);
```

然后根据[模块名].json文件中定义的初始化阶段数据需求，使用Set()函数输入数据。

例：so中有地图匹配需求，需要事先输入MAP结构体数据。

```c
// MEC软件一侧调用
bool bflag = Set(
    MEC_A_MAP_DATAFRAME,                    // 输入数据类型
    0,
    100,                                    // p指向结构体的大小
    0.0, 
    NULL, 
    (void*)p,                               // p指向输入的结构体
    &app_errmsg); 
if (!flag) {
    // TODO: 停止输入MAP结构体
    // TODO: 读取app_errmsg中的错误和异常信息
}
// TODO: 输入so库要求的初始化阶段输入的其他结构体...
```

#### 10.6.2 输入数据

首先通过MEC_A_COM_TIMESTAMP输入当前时间戳。如果返回false，说明so库在当前迭代不工作，MEC软件应当在下一迭代再通过输入时间戳询问so库的工作状态。

```c
bool bflag = Set(
    MEC_A_COM_TIMESTAMP,
    (long)std::time(0),
    0, 
    0.0, 
    NULL, 
    NULL, 
    &app_errmsg);
if (!bflag) {
    // TODO: 处理app_errmsg，跳过本so
}
```

剩余输入数据分2阶段。

##### 实时数据

根据[模块名].json文件中定义的输入数据需求，依次调用Set()函数输入实时数据。数据输入顺序没有要求，可以

```c
// MEC软件一侧调用
bool bflag = true;
bflag = Set(MEC_A_TS_DATAFRAME, 
            0,      
            90,     // p指向结构体的大小
            0.0,
            NULL,
            (void*)p,
            &app_errmsg);
if (!bflag)
{
    // TODO: 停止输入TrafficSign结构体
    // TODO: 读取app_errmsg中的错误和异常信息
    break;
}
}
```

##### 历史数据

根据[模块名].json文件中定义的输入数据需求，依次调用Set()函数输入历史数据。

历史数据共有5种可能的长度，对于每一种结构体，只能选择其中一种长度。MEC根据so库在配置文件中提出的数据需求，输入从1分钟、2分钟、5分钟、10分钟或15分钟前至当前时刻该结构体的所有数据。以VolumeLane类为例

```c
// mec_lib.h
#define     MEC_A_VL_HISTORY_1                  1061        // 1min
#define     MEC_A_VL_HISTORY_2                  1062        // 2min
#define     MEC_A_VL_HISTORY_5                  1063        // 5min
#define     MEC_A_VL_HISTORY_10                 1064        // 10min
#define     MEC_A_VL_HISTORY_15                 1065        // 15min
```

向数据库请求历史数据前，MEC软件使用Set(MEC_A_XX_HISTORY_Y...)获知当前so库是否需要输入在json配置文件中要求的历史数据，若返回false，则不需要输入历史数据，减少不必要的数据库请求。

```c
// MEC软件侧执行
// TODO: 获取TrafficSign结构体前1分钟的全部历史数据
// 获知是否需要历史数据，结构体尺寸long_value2=0
bool bflag = Set(MEC_A_TS_HISTORY_1, 0, 0, 0.0, NULL, NULL, &app_errmsg);
if (bflag)
{
    while (...)    // 直到输入获得的全部结构体为止
    {
        bflag = Set(MEC_A_TS_HISTORY_1, 
                    0,
                    60,    // 历史数据结构体大小
                    0.0,
                    NULL,
                    (void*)p,  // 历史数据结构体
                    &app_errmsg);
        if (!bflag)
        {
            // TODO: 停止输入TrafficSign结构体
            // TODO: 读取app_errmsg中的错误和异常信息
            break;
        }
    }
}
else
{
    // TODO: 停止输入TrafficSign结构体
    // TODO: 读取app_errmsg中的错误和异常信息
}
```

#### 10.6.3 命令

所有数据输入完成后，执行Command(MEC_COMMAND_EXEC)，Command()函数返回true即算法执行完毕，且成功执行。返回false时，so向app_errmsg写入执行失败的原因或发生的内部错误。

```
bool bflag = Command(MEC_COMMAND_EXEC, 0, 0.0, NULL, NULL, &app_errmsg);
```

#### 10.6.4 输出数据

根据[模块名].json文件中定义的输出数据需求。考虑到可能有多个输出消息属于同一结构体，MEC软件将对同一个数据项多次Get()，so依次输出该类型下需要输出的结构体数据块buffer，直到Get()函数返回false（返回false的当次函数调用不输出任何数据）。此时，参数long_value2用于传递数据块buffer大小，参数string_value表示外设id，用于指明应当通过哪个外设把数据发送出去。

```c
long m, n;                              // 需要输出的RSI结构体个数和序号
long size;                              // 当前输出的RSI的结构体大小，单位：byte
char buf[MAX_FB_SIZE] = { 0 };          // #include "mec_lib.h"
char dev_id[MAX_DEV_ID_SIZE] = { 0 };   // #include "mec_lib.h"
bool bflag = Get(MEC_R_RSI_COUNTS, &m, NULL, NULL, NULL, &app_errmsg);
if (!bflag) {
    // TODO: 停止输出，读取app_errmsg中的错误和异常信息
}
for (long i = 0; i < m; i++)
{
    bflag = Get(MEC_R_RSI, &n, &size, NULL, (void*)dev_id, (void*)buf, &app_errmsg);
    if (i != n) {
        // TODO: 可能漏发信息
    }
    // TODO: buf中的数据加入消息发送队列中，清空buf
}
```

#### 10.6.5 卸载

Command(MEC_COMMAND_EXIT)。so库释放申请的内存或文件I/O流等系统资源。函数返回后，so库被卸载。

```
bool bflag = Command(MEC_COMMAND_EXIT, 0, 0.0, NULL, NULL, &app_errmsg);
```

### 10.7 数据和命令定义

so库接口函数中所使用的输入输出数据唯一标识符和指令标识符已经全部在mec_lib.h中定义：

- MEC_COMMAND_XXX: 指令
- MEC_A_YY_XX：不同大类的数据中的数据项，XX=DATAFRAME时为该数据大类的结构体
- MEC_R_XX_COUNTS: 数据输出项数量
- MEC_R_XX: 数据输出项

so库大量使用Google开发的Flatbuffers包定义输入输出结构体，相关文档：

- 快速入门：https://blog.csdn.net/guotianqing/article/details/100691267
- Google官方详细文档(Eng)：http://google.github.io/flatbuffers/（内含安装方法，见building节，请使用vcpkg包管理器安装）

## 十一、SO库范例

```c
// Copyright: 兆边（上海）科技有限公司
// Author: 林启恒
// Date: 2021-1-27
// Version: 0.3
// Description: 无条件信号优先演示 应用so库及so库编写范例
// C系统文件
#include <string.h>
// C++系统文件
#include <memory>
#include <vector>
// 其他库.h文件
#include "MECInfo_generated.h"  // 外设管理数据结构
#include "SafetyMessage_generated.h"  // 输入需要使用SafetyMessage结构体，使用Google的Flatbuffers包
#include "SignalPhaseAndTiming_generated.h"  // 输出需要使用SPAT结构体，使用Google的Flatbuffers包
// 本项目内.h文件
#include "mec_lib.h"  // 所有so库必须引用
// 用于储存单个计算结果buffer及其大小
struct ResultVectorElement {
    std::unique_ptr<uint8_t[]> p;
    size_t size;
    std::string to;
    ResultVectorElement(uint8_t* _p, size_t _size, std::string& _to)
        : size(_size), p(std::move(_p)), to(_to) {}
    ResultVectorElement(ResultVectorElement&& _rve) noexcept
        : size(_rve.size), p(std::move(_rve.p)), to(_rve.to) {}
    ResultVectorElement& operator=(ResultVectorElement&& _rve) {
        p = std::move(_rve.p);
        size = _rve.size;
        to = _rve.to;
        return *this;
    }
};
// Global variables
long timestamp = 0;               // 当前Unix时间戳
long sm_counts = 0;               // SafetyMessage结构体输入数量
long sm_count = 0;                // SafetyMessage结构体输入计数器
std::vector<const uint8_t*> vsm;  // SafetyMessage结构体指针向量
long spat_counts = 0;             // SPAT结构体输出数量
long spat_count = 0;              // SPAT结构体输出计数器
std::vector<ResultVectorElement> vspat;  // SPAT结构体指针向量
std::string destination;                 // SPAT结构体输出目的外设
flatbuffers::FlatBufferBuilder builder;  // Flatbuffers结构体构建器
extern "C" bool Command(
    const long command_type,    // 指令唯一标识符
    const long long_value1,     // long parameter 1, 0 while not used
    const long long_value2,     // long parameter 2, 0 while not used
    const double double_value,  // double parameter, 0.0 while not used
    const char* string_value,   // string parameter, NULL while not used
    const void* void_value,  // parameter of other complex data structures, NULL
    // while not used
    APP_ErrMsg* app_errmsg   // error message
) {
    switch (command_type) {
        case (MEC_COMMAND_INIT): {
            // Initialization
            // Do NOTHING in this APP
            app_errmsg->err_id = MEC_E_SUCCEED;  // 命令执行成功
            return true;
        }
        case (MEC_COMMAND_EXEC): {
            // Command Execution
            builder.Clear();
            if (!vsm.empty()) {  // 收到SafetyMessage信号，需要信号优先
                // Set SPAT counts
                spat_counts = 1;
                // Create Flatbuffer
                // 请勿先创建XXXBuilder，否则会报错
                // 建议从内层向外层
                MECData::DF_LightState light_state =
                    MECData::DF_LightState::DF_LightState_permissiveMovementAllowed;
                auto time_change_details =
                    MECData::CreateDF_TimeCountingDown(builder).Union();
                auto phase_state = MECData::CreateDF_PhaseState(
                    builder, light_state,
                    MECData::DF_TimeChangeDetails_DF_TimeCountingDown,
                    time_change_details);
                std::vector<flatbuffers::Offset<MECData::DF_PhaseState>> phs;
                phs.push_back(phase_state);
                auto phase_states = builder.CreateVector(phs);
                auto phase = MECData::CreateDF_Phase(builder, 1, phase_states);
                std::vector<flatbuffers::Offset<MECData::DF_Phase>> ps;
                ps.push_back(phase);
                auto phases = builder.CreateVector(ps);
                auto node_reference_id =
                    MECData::CreateDF_NodeReferenceID(builder, 1, 2);
                MECData::DF_IntersectionStatusObject iso(4);
                unsigned int moy = 527040;
                auto intersection_state = MECData::CreateDF_IntersectionState(
                    builder, node_reference_id, &iso, moy,
                    static_cast<uint16_t>(timestamp),
                    MECData::DF_TimeConfidence::DF_TimeConfidence_unavailable, phases);
                std::vector<flatbuffers::Offset<MECData::DF_IntersectionState>> vis;
                vis.push_back(intersection_state);
                auto ints = builder.CreateVector(vis);
                auto spat_name = builder.CreateString("Demo SPAT");
                MECData::MSG_SignalPhaseAndTimingBuilder spat_builder(builder);
                spat_builder.add_timeStamp(static_cast<uint16_t>(timestamp));
                spat_builder.add_name(spat_name);
                spat_builder.add_intersections(ints);
                auto orc = spat_builder.Finish();
                // Flatbuffer finished
                builder.Finish(orc);  // 完成创建，可提取buffer位置和大小
                size_t bufsize = builder.GetSize();
                ResultVectorElement rve((new uint8_t[bufsize]), bufsize,
                                        destination);  // 申请与buffer等大的空间
                memcpy(rve.p.get(), builder.GetBufferPointer(),
                       bufsize);  // 已生成的buffer储存
                vspat.push_back(
                    std::move(rve));  // 储存到向量中，必须使用move()移动语义
            } else {
                spat_counts = 0;
            }
            // 执行算法
            app_errmsg->err_id = MEC_E_SUCCEED;  // 命令执行成功
            return true;
        }
        case (MEC_COMMAND_EXIT): {
            // Free resources
            app_errmsg->err_id = MEC_E_SUCCEED;  // 命令执行成功
            return true;
        }
        default: {
            app_errmsg->err_id = MEC_E_UNKNOWN;  // 未知命令
            return false;
        }
    }
}
extern "C" bool Set(
    const long data_type,       // 输入数据项唯一标识符
    const long long_value1,     // long data 1, 0 while not used
    const long long_value2,     // long data 2, 0 while not used
    const double double_value,  // double data, 0.0 while not used
    const char* string_value,   // string data, NULL while not used
    const void* void_value,     // data of other complex data structures, NULL
    // while not used
    APP_ErrMsg* app_errmsg      // error message
) {
    // 基本上都是传结构体的指针，存在void_value中
    // 只存指针，不需要复制实际的值，直接用指针的值
    switch (data_type) {
        case (MEC_A_COM_TIMESTAMP): {
            timestamp = long_value1;  // 记录当前时间戳
            vsm.clear();  // 清空上一次迭代中的记录的SafetyMessage结构体指针
            return true;  // 返回false，则放弃本轮计算，无后续输入输出
            // 可以由此进行算法触发频率控制
        }
        case (MEC_A_SM_DATAFRAME): {
            // 检查结构体是否为空及指向buffer是否为期望类型
            if (void_value == NULL) {
                sm_count = sm_counts = 0;                    // 计数器复位
                app_errmsg->err_id = MEC_E_INPUT_CORRUPTED;  // 输入数据结构损坏
                snprintf(app_errmsg->err_msg, sizeof(app_errmsg->err_msg), "%s",
                         "null pointer");
                return false;
            }
            // 检查结构体是否为期望类型
            // VerifyXXBuffer()
            auto vf = flatbuffers::Verifier(
                reinterpret_cast<const uint8_t*>(void_value), long_value2);
            bool ok = MECData::VerifyMSG_SafetyMessageBuffer(
                vf);  // long_value2保存结构体大小
            if (!ok) {
                sm_count = sm_counts = 0;                    // 计数器复位
                app_errmsg->err_id = MEC_E_INPUT_CORRUPTED;  // 输入数据结构损坏
                snprintf(app_errmsg->err_msg, sizeof(app_errmsg->err_msg), "%s",
                         "corrupted buffer");
                return false;
            }
            // 处理buffer
            vsm.push_back(
                reinterpret_cast<const uint8_t*>(void_value));  // 把指针记录到向量中
            return true;
        }
        case (MEC_A_COM_MEC_INFO): {
            if (void_value == nullptr) {
                app_errmsg->err_id = MEC_E_INPUT_CORRUPTED;  // 输入数据结构损坏
                snprintf(app_errmsg->err_msg, sizeof(app_errmsg->err_msg), "%s",
                         "null pointer");
                return false;
            }
            auto vf = flatbuffers::Verifier(
                reinterpret_cast<const uint8_t*>(void_value), long_value2);
            bool ok = MECData::VerifyMSG_MECInfoBuffer(vf);
            if (!ok) {
                snprintf(app_errmsg->err_msg, sizeof(app_errmsg->err_msg), "%s",
                         "corrupted buffer");
                return false;
            }
            // 假设只有一个RSU，只找到第一个RSU类型的外设
            ok = false;
            auto mec_info = MECData::GetMSG_MECInfo(void_value);
            auto dev_manage = mec_info->deviceManage();
            auto dm_len = dev_manage->size();
            for (uint32_t i = 0; i < dm_len; i++) {
                if (dev_manage->Get(i)->deviceType() == DEV_RSU) {
                    destination = dev_manage->Get(i)->id()->c_str();
                    ok = true;
                    break;
                }
            }
            if (!ok) destination = "rsu_0";
            app_errmsg->err_id = MEC_E_SUCCEED;
            return true;
        }
        default: {
            app_errmsg->err_id = MEC_E_NOT_NEEDED;  // 输入了不需要的数据
            return false;
        }
    }
}
extern "C" bool Get(
    const long data_type,   // 输出数据项唯一标识符
    long* long_value1,      // int data 1
    long* long_value2,      // int data 2
    double* double_value,   // double data
    char* string_value,     // string data, max length = 256
    void* void_value,       // parameter of other complex data structures
    APP_ErrMsg* app_errmsg  // error message
) {
    // so内存中创造一个结构体buffer，把结构体的memcpy到void_value中，
    switch (data_type) {
        case (MEC_R_SPAT_COUNTS): {
            spat_counts = static_cast<long>(vspat.size());  // 保存
            *long_value1 =
                spat_counts;  // 输出到long_value1指向内存，注意指针取值运算符
            spat_count = 0;  // 输出计数器清零
            app_errmsg->err_id = MEC_E_SUCCEED;
            return true;
        }
        case (MEC_R_SPAT): {
            *long_value1 = spat_count;                   // 输出计数器
            auto it = vspat.begin();                     // 取vector中第1个元素
            memcpy(void_value, it->p.get(), it->size);   // 深拷贝buffer
            *long_value2 = static_cast<long>(it->size);  // 输出buffer大小
            snprintf(string_value, MAX_DEV_ID_SIZE, "%s",
                     destination.c_str());  // 发送到RSU
            vspat.erase(it);  // 已输出的buffer，so库内部vector不再储存，删除
            spat_count++;  // 输出计数器迭代
            app_errmsg->err_id = MEC_E_SUCCEED;
            return true;
        }
        default: {
            app_errmsg->err_id = MEC_E_NOT_NEEDED;  // 要求了没有在json中声明的输出
            return false;
        }
    }
}
```

## 十二、SO库命名规范

SO库相关文件命名与配置文件填写内容，由若干基本元素按照一定规律组合而成。

### 12.1 基本元素

构成基本元素的信息见附件

- 应用大类：以大写英文字母命名，附件Excel“类别”列
- 应用编号：附件Excel“编号”列
- 应用名称：英语，大驼峰法命名，如“大雾环境预警”译为`FogWarning`。由于应用名称结尾多为动词，对于部分高频动词，建议采用下表翻译

| 动词 | 建议翻译   |
| ---- | ---------- |
| 预警 | Alert      |
| 警告 | Warning    |
| 建议 | Advice     |
| 提醒 | Alert      |
| 辅助 | Assistance |

未尽列者自行翻译，在pull request阶段审查命名合理性。

### 12.2 命名规律

- `id`：[应用大类][应用编号]
- `name`：[应用名称]
- `lib`：lib+[应用名称]+.so （不含“+”，注意编译后的文件名可能带有数字后缀，以编译后文件名为准）
- `config`：[应用大类][应用编号]_[应用名称].json

以大雾环境预警为例

```c
{
    "apps": [
        {
            "id": "A33",
            "name": "FogWarning",
            "lib":  "libFogWarning.so",
            "config": "A33_FogWarning.json",
            "description": "Example app",
            "async": false,
            "priority": 284
        }
    ]
}
```

若后续发生so库功能合并，则取原有关so库应用编号最小的一个，作为合并后so库的应用编号，名称按照上文规定重新取，合并后so库优先级取合并前所有so库中最高值。

### 12.3 命名规范审查

在本分支向`main`或者`master`分支发起pull request时进行审查，不合要求的将被拒绝merge，需要修改后再提交。

##### 📎 文档包含附件，点击预览/下载

- [MEC场景20210209.xlsx](http://108.61.183.243/storage/files/20210210/1110/MEC场景20210209.xlsx)

