# 物联网 感知控制设备接入	第1部分:总体要求

2020-04-28发布 2020-11-01实施

# 1 范围

GB/T38637的本部分规定了物联网系统中感知控制设备接入的接入要求、应用层接入协议和协议适配。
本部分适用于物联网感知控制设备的规划和研发。

# 3 术语和定义

下列术语和定义适用于本文件。

## 3.1 感知控制设备 senseandcontroldevice

处于物联网感知控制域,具备与外部系统双向通信能力,用于收集物理世界的信息并能够发送或接收处理外部命令的装置。

## 3.2 智能感知控制设备 intelligentsenseandcontroldevice

具有信息处理部件的感知控制设备(3.1)。

## 3.3 物联网网关 internetofthingsgateway

具有数据存储能力、计算能力和协议转换能力等,可通过北向接口与应用平台建立通信连接和通过南向接口与感知控制设备进行通信的实体,其形态可以是独立设备或软件。

## 4 缩略语

下列缩略语适用于本文件。
AAP:应用层接入协议(AccessApplicationProtocol)
HTTP:超文本传输协议(HyperTextTransferProtocol)
JSON:JS对象简谱(JavaScriptObjectNotation)
MQTT:遥测传输协议(MessageQueueTelemetryTransport)
SSL:安全套接层(SecureSocketsLayer)
TLS:安全传输层协议(TransportLayerSecurity)

# 5 总体要求

根据GB/T33474—2016给出的物联网参考体系结构,感知控制设备接入至资源交换域、服务提供域和运维管理域主要实现以下三种目的:
a) 接入资源交换域的软硬件系统，实现信息交互与共享;
b) 接入服务提供域的基础服务系统，实现感知和操控信息交互;
c) 接入运维管控域的软硬件系统，实现信息交互与共享。
感知控制设备接入所涉及的关联关系如图1所示的关联关系7、关联关系8和关联关系9。

![image-20210726151142367](https://gitee.com/er-huomeng/l-img/raw/master/img/image-20210726151142367.png)

实际物联网系统中，资源交换域、服务提供域和运维管控域的软硬件设备通常部署在云端或中心服务器，构成应用平台。感知控制设备接入应用平台的方式可分为经物联网网关的间接接入和不经物联网网关的直接接入，如图2所示，其中感知控制设备或者物联网网关可采用应用层接入协议接入应用平台。

接入方式如下:
a) 间接接入：感知控制设备的通信能力或数据处理能力有限时，多个感知控制设备经物联网网关汇聚中转,接入应用平台。感知控制设备通过本地局域网络与物联网网关连接,物联网网关通过广域网络与应用平台连接。物联网网关提供协议转换、地址映射、数据处理等功能。
b) 直接接入：感知控制设备可直接与其他域中设备或系统进行互联。

![image-20210726151206196](https://gitee.com/er-huomeng/l-img/raw/master/img/image-20210726151206196.png)

## 6.1 接入设备

应支持非智能感知控制设备和智能感知控制设备两种类型设备接入。

## 6.2 物联网网关

物联网网关在间接接入方式中应满足如下要求:
a) 非智能感知控制设备应采用模拟信号接入物联网网关;
b) 智能感知控制设备应采用数字信号接入物联网网关;
c) 物联网网关应采用数字信号接入应用平台。

## 6.3 感知控制设备与物联网网关的接入通信方式

感知控制设备接入物联网网关的通信方式要求如下:
a) 宜采用有线或短距离无线传输网络;
b) 宜支持相应的有线或无线传输协议。

## 6.4 物联网网关与应用平台之间的接入通信方式

物联网网关接入应用平台的通信方式要求如下:
a) 宜采用专用或公用数据通信网络,如专用光纤传输或者运营商提供的移动通信网络等;
b) 宜支持主备用通信方式共存和主备用通信方式自动切换;
c) 应采取有效的网络通信安全防护措施,保证通信安全。

# 7 直接接入一般要求

# 7.1 接入设备

应支持智能感知控制设备接入。

## 7.2 感知控制设备与应用平台的接入通信方式

感知控制设备接入应用平台的通信方式要求如下:
a) 通常宜采用广域无线通信方式,如蜂窝网络、非蜂窝网络等;
b) 有特殊需求时,可使用有线通信方式;
c) 应采取有效的网络通信安全防护措施,保证通信安全。

# 8 应用层接入协议(AAP)

## 8.1 概述

<font color='red'>AAP属于应用层消息类协议,其运行载体为智能感知控制设备、物联网网关(间接接入时)和应用平台。</font>
AAP适配以下三类底层协议:
a) <font color='red'>基于消息代理进行发布和订阅的消息协议,如 MQTT等;</font>
b)<font color='red'> 基于请求/响应的点对点应用层协议,如HTTP等;</font>
c)<font color='red'> 点对点的消息包传送协议,如 Websocket等。</font>

## 8.2 消息格式和消息类型

AAP消息由协议行、消息头和消息体三部分构成:
a) 协议行应至少包括格式标志和协议版本号。协议行的第1个字节是消息格式标志,表示消息头和消息体的编码格式。如,由“J”开头代表JSON格式,由“B”开头代表二进制格式。
b) 消息头应至少包括消息类型,还可包括时间戳、消息体的编码指示、压缩相关信息、认证和加密的信息等。
c) 消息接收端应根据消息头进行消息体的识别、解码、认证和解密。
AAP的消息及消息类型见表1,除注销消息外其余每种消息包括请求消息和应答消息两种类型(其名称用原语给出),消息描述是对该种消息的描述。

![image-20210726151312844](https://gitee.com/er-huomeng/l-img/raw/master/img/image-20210726151312844.png)

物联网网关注册消息等4种消息的示例参见附录A。

## 8.3 消息交互模型

AAP包括通知模型、请求应答模型、选择性应答模型和延迟应答模型四种交互模型:
a) 通知模型中,发送端将消息发送至接收者,接收者无需应答,见图3。

![image-20210726151333898](https://gitee.com/er-huomeng/l-img/raw/master/img/image-20210726151333898.png)

b) 请求应答模型中,发送端将消息发送至接收者,接收者将应答消息反馈至发送端,见图4。

![image-20210726151419891](https://gitee.com/er-huomeng/l-img/raw/master/img/image-20210726151419891.png)

c) 选择性应答模型中,发送端将请求消息,其应答标志为0,在发送指定的请求条数或间隔指定时长后,发送请求消息,其应答标志为1,要求接收端发回应答消息,以确认接收端已收到该请求之前的全部消息,见图5。

![image-20210726151432491](https://gitee.com/er-huomeng/l-img/raw/master/img/image-20210726151432491.png)

d) 延迟应答模型中,发送端将请求消息发送至接收端,其应答标志为1,接收端反馈应答消息确认收到请求消息。接收端处理完请求消息后,向发送端发送请求消息,其应答标志为1,将处理结果报告发送端,发送端发回应答消息,表示收到处理结果。若接收端发送完处理结果后不能接收到应答消息,可以选择通过请求消息重传处理结果,见图6。

![image-20210726151449267](https://gitee.com/er-huomeng/l-img/raw/master/img/image-20210726151449267.png)

## 8.4 协议流程

协议流程分以下四个阶段:
a) <font color='red'>连接建立阶段:物联网网关或智能感知控制设备与应用平台建立连接;</font>
b) <font color='red'>设备注册阶段:物联网网关或智能感知控制设备向应用平台发起注册请求,并得到回复,应用平台显示物联网网关或智能感知控制设备在线;</font>
c) <font color='red'>消息交互阶段:物联网网关或智能感知控制设备与应用平台之间进行信息交互,比如应用平台下发命令、物联网网关或智能感知控制设备上报数据以及两者之间发送连接保持消息;</font>
d)<font color='red'> 连接断开阶段:物联网网关或智能感知控制设备向应用平台发送注销请求,应用平台不再保持相关设备的状态。</font>

## 8.5 协议功能协商要求

协议双方可以协商具体协议实现功能,主要包括以下三种协商模式:
a) 主动核实双方功能:物联网网关或智能感知控制设备与应用平台建立连接后,主动查询对方所支持的功能;
b) 主动报告支持功能:物联网网关或智能感知控制设备与应用平台建立连接后,主动报告对方所支持的功能;
c) 收到未知请求消息时主动报告支持功能:在收到未知请求消息时,主动报告对方所支持的请求消息。

## 8.6 安全要求

AAP至少采用以下安全机制:
a) 应用平台与物联网网关或智能感知控制设备间应采用账号和密码的方式进行认证;
b) 应采用TLS/SSL协议对传输的数据进行加密和签名,保证数据的私密性和完整性;
c) 对于敏感数据或控制操作可采用更高强度的加密和认证策略。

# 9 协议适配

## 9.1 消息主题

消息主题应包括<font color='red'>消息主题标识、接入账号、消息发送或接收设备标识。</font>

不同的底层协议传输模式对消息主题采用不同的处理方式,具体如下所示:
a) 底层协议宜采用消息代理的传输模式,通过消息主题进行发送和订阅;
b) 底层协议宜采用点对点的传输模式,消息主题封装至底层协议的消息包中。

## 9.2 底层协议服务接口

底层协议对上提供服务时应满足如下要求:
a) 底层协议向AAP提供服务接口。
b) AAP调用底层协议服务接口时传递消息连接标识。消息连接标识在物联网网关或智能感知控制设备在应用平台注册时生成,用来唯一标识物联网网关或智能感知控制设备与应用平台之间的消息连接。
c) 底层协议向AAP提供服务接口,包括(但不限于):
1) 接入地址绑定接口:AAP通过此接口向底层协议提供接入地址和相关的接入参数。
2) 设备登记接口:底层协议通过此接口验证AAP消息是否合法。

3) 连接建立接口:对于采用消息代理模式的底层协议,AAP调用此接口时,物联网网关或智能感知控制设备与应用平台都连接至消息代理,并且订阅相关的消息主题;物联网网关或智能感知控制设备在应用平台注册成功后,AAP连接建立同时底层协议标记为连接已建立。在注册失败时,AAP向协议对等端发送注册失败消息后,调用底层协议的连接关闭接口,关闭连接。对于点对点传输模式的底层协议,AAP调用此接口,实现物联网网关或智能感知控制设备与应用平台的直接连接,其余流程与消息代理模式相同。
4) 消息发送接口:AAP调用此接口实现协议消息的发送。
5) 消息报告接口:底层协议收到AAP消息后,调用此接口可将接收到的消息上报至AAP。
6) 连接状态查询接口:AAP通过调用此接口可以查询连接状态。
7) 连接关闭接口:如果物联网网关或智能感知控制设备向应用平台发送注销请求,或者消息代理报告物联网网关或智能感知控制设备已经断开连接,AAP调用此接口关闭连接。

## 9.3 底层协议适配

### 9.3.1 MQTT协议

与 MQTT(遥测传输协议)适配时:
a) <font color='red'>AAP的消息主题应直接映射到 MQTT的主题;</font>
b)<font color='red'> AAP中的消息应直接封装至 MQTT消息体中;</font>
c) <font color='red'>AAP的接入账号和接入密码应对应 MQTT中消息代理的客户端账号和密码。</font>

### 9.3.2 HTTP协议

与HTTP适配时:
a) HTTP的头部应增加相应的头部字段;
b) 宜实现应用平台与物联网网关或智能感知控制设备之间多种交互模式。

### 9.3.3 Websocket协议

与 Websocket适配时,AAP的消息主题和消息体应直接封装到 Websocket消息中。

# 附录A AAP消息示例

## A.1 概述

A.2中的消息示例用JSON格式描述,其中消息编号见表A.1,缩略语及其代替字段名见表A.2。

![image-20210726151616555](https://gitee.com/er-huomeng/l-img/raw/master/img/image-20210726151616555.png)

![image-20210726151627204](https://gitee.com/er-huomeng/l-img/raw/master/img/image-20210726151627204.png)

![image-20210726151635906](https://gitee.com/er-huomeng/l-img/raw/master/img/image-20210726151635906.png)

## A.2 物联网网关注册

### A.2.1 注册请求消息

消息示例如下:

![image-20210726151700061](https://gitee.com/er-huomeng/l-img/raw/master/img/image-20210726151700061.png)

注:上述示例中,“/ge/Access_account/gatewayid1”为以JSON格式表示消息主题的示例,其中ge为消息主题标识、Access_account为接入账号,gatewayid1为消息发送设备。

### A.2.2 注册应答消息

消息示例如下:

![image-20210726151820453](https://gitee.com/er-huomeng/l-img/raw/master/img/image-20210726151820453.png)

## A.3 智能感知控制设备注册

### A.3.1 注册请求消息

消息示例如下:

![image-20210726151853155](https://gitee.com/er-huomeng/l-img/raw/master/img/image-20210726151853155.png)

### A.3.2 注册应答消息

消息示例如下:

![image-20210726151910243](https://gitee.com/er-huomeng/l-img/raw/master/img/image-20210726151910243.png)

## A.4 连接保持

### A.4.1 连接保持请求消息

连接保持请求消息示例如下:

![image-20210726151943506](https://gitee.com/er-huomeng/l-img/raw/master/img/image-20210726151943506.png)

### A.4.2 连接保持应答消息

连接保持应答消息示例如下:

![image-20210726152002906](https://gitee.com/er-huomeng/l-img/raw/master/img/image-20210726152002906.png)

## A.5 注销消息

注销消息示例如下:

![image-20210726152013820](https://gitee.com/er-huomeng/l-img/raw/master/img/image-20210726152013820.png)